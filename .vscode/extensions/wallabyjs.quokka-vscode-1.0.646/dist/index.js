/*
 * quokka-vscode - v1.0.646
 * Copyright (c) 2017-2024 WallabyJs - All Rights Reserved.
 */

!function e(t,i,s){process.env.WALLABY_PRODUCTION=!0;var o="function"==typeof require&&require;module.exports=function a(n,r){if(!i[n]){if(!t[n]){var l="function"==typeof require&&require;if(!r&&l)return l(n,!0);if(o)return o(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var d=i[n]={exports:{}};t[n][0].call(d.exports,function(e){var i=t[n][1][e];return a(i||e)},d,d.exports,e,t,i,s)}return i[n].exports}(s[0])}({1:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function r(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,r)}l((s=s.apply(e,t||[])).next())})};let o=e("os"),a=e("fs"),n=e("path"),r=e("vscode"),l=e("./lib/compositeDisposable");const c=e("./lib/startViewPanel");class d{activate(t){return s(this,void 0,void 0,function*(){r.window.registerWebviewPanelSerializer&&r.window.registerWebviewPanelSerializer(c.viewType,{deserializeWebviewPanel(e){return s(this,void 0,void 0,function*(){c.revive(e,t)})}});let i=this;i._disposables=new l;let o=e(t.globalState.get("corePath")),a={context:t,coreClient:o,deactivate:()=>i.deactivate(),version:d._getVersion()},n=e("./lib/controller");i._controller=new n(a),i._controller.activate(),i._disposables.add(()=>i._controller.deactivate())})}static _getVersion(){let e=1,t=0;try{let i=r.version.split(".");e=parseInt(i[0],10),t=parseInt(i[1],10)}catch(e){}return{major:e,minor:t}}deactivate(){this._disposables.dispose()}}i.activate=(e=>{let t=new d;e.subscriptions.push({dispose:()=>t.deactivate()});const i=d._getVersion();if(i.major<=1&&i.minor<18){const e=process.exit,i=function(){t.deactivate(),e.apply(process,arguments)},s=process.exit=function(){i.apply(null,arguments)};process.on("SIGINT",function(){s.apply(null,arguments)}),process.on("SIGTERM",function(){s.apply(null,arguments)}),process.on("exit",function(){s.apply(null,arguments)})}try{let t=r.workspace.getConfiguration();if(t){let i=t.get("quokka.colors",{});i&&Object.keys(i).forEach(t=>{try{if(!t)return;let s=e.asAbsolutePath(n.join("images",t+".svg"));if(!a.existsSync(s))return;const r=('<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="16px" height="16px">'+o.EOL+"  <g>"+o.EOL+'    <rect x="2.5" y="2.5" width="11" height="11" rx="2.5" ry="2.5" style="fill:#62b455;fill-opacity:1;" />'+o.EOL+"  </g>"+o.EOL+"</svg>").replace(/fill:#.[^;]*/,"fill:"+i[t]),l=a.readFileSync(s).toString();r.replace(/\r/g,"")!==l.replace(/\r/g,"")&&a.writeFileSync(s,r)}catch(e){console.error("Failed to set icon "+t+" type to "+i[t]+". "+e.message)}})}}catch(e){}t.activate(e)})},{"./lib/compositeDisposable":6,"./lib/controller":7,"./lib/startViewPanel":11,fs:void 0,os:void 0,path:void 0,vscode:void 0}],2:[function(e,t,i){"use strict";var s=e("vscode"),o=e("path");i.activate=function(t){var i=s.workspace.getConfiguration()&&s.workspace.getConfiguration().get("quokka.debug",!1);i?(global.originalRequire=e,t.globalState.update("corePath","../../wallaby/client")):t.globalState.update("corePath","./wallaby/client"),i?e("./out/extension").activate(t):"dist"===o.basename(__dirname)?e("./extension").activate(t):(global.originalRequire=e,e("./dist/index").activate(t))}},{"./extension":1,path:void 0,vscode:void 0}],3:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function r(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,r)}l((s=s.apply(e,t||[])).next())})};Object.defineProperty(i,"__esModule",{value:!0}),i.InteractiveExamples=void 0;const o=e("path"),a=e("fs"),n=e("os"),r=e("https");i.InteractiveExamples=class{constructor(){this.examples=[],this.disposable=void 0,this.disposed=!1,this.configPath=o.join(n.homedir(),".quokka","examples.json"),this.examplesPath=o.join(n.homedir(),".quokka","interactive-examples")}httpGet(e){return s(this,void 0,void 0,function*(){return new Promise((t,i)=>{r.get(e,{headers:{"User-Agent":"Quokka-VSCode-Extension"}},e=>s(this,void 0,void 0,function*(){if(e.statusCode&&e.statusCode>=300&&e.statusCode<400&&e.headers.location)try{const s=yield this.httpGet(e.headers.location);t(s)}catch(e){i(e)}else{let i=Buffer.alloc(0);e.on("data",e=>{i=Buffer.concat([i,e])}),e.on("end",()=>{t(i)})}})).on("error",e=>{i(e)})})})}deleteOldExamplesFolder(){const e=function(t){a.existsSync(t)&&(a.readdirSync(t).forEach(function(i){var s=o.join(t,i);a.lstatSync(s).isDirectory()?e(s):a.unlinkSync(s)}),a.rmdirSync(t))};e(this.examplesPath)}getExampleMetaInformation(){let e=[];const t=this.examplesPath,i=function(s){a.existsSync(s)&&a.readdirSync(s).forEach(function(n){var r=o.join(s,n);if(a.lstatSync(r).isDirectory())i(r);else if("meta.json"===n)try{const i=JSON.parse(a.readFileSync(r).toString());e=[...e,...i.map(e=>(e.folder=o.relative(t,s),e.label=e.title,delete e.title,e))]}catch(e){}})};return i(this.examplesPath),e}initialize(){return s(this,void 0,void 0,function*(){try{if(a.existsSync(this.configPath)){const e=JSON.parse(a.readFileSync(this.configPath).toString());this.examples=e.examples,this.nextCheckTime=e.nextCheckTime,this.sha=e.sha,this.date=e.date}}catch(e){console.error(e)}if(!this.nextCheckTime||(new Date).getTime()>this.nextCheckTime){const t="https://api.github.com/repos/wallabyjs/interactive-examples/commits"+(this.date?"?since"+this.date:"");try{const i=yield this.httpGet(t),s=JSON.parse(i.toString());if(s.length&&this.sha!==s[0].sha){const t=yield this.httpGet("https://github.com/wallabyjs/interactive-examples/archive/master.zip");new(e("adm-zip"))(t).extractAllTo(o.join(n.homedir(),".quokka"),!0),this.deleteOldExamplesFolder(),a.renameSync(o.join(n.homedir(),".quokka","interactive-examples-master"),this.examplesPath),this.examples=this.getExampleMetaInformation(),this.sha=s[0].sha,this.date=s[0].commit.committer.date,this.nextCheckTime=(new Date).getTime()+864e5,a.writeFileSync(this.configPath,JSON.stringify({examples:this.examples,nextCheckTime:this.nextCheckTime,sha:this.sha,date:this.date}))}}catch(e){console.error(e)}}})}getExamples(){return this.examples||[]}getContent(e){try{return a.readFileSync(o.join(this.examplesPath,e.folder,e.fileName)).toString()}catch(e){return""}}getLanguage(e){return"ts"===e.type?"TypeScript":"JavaScript"}getRelativeFilePath(e){return o.join(e.folder,e.fileName)}dispose(){this.disposable&&this.disposable.dispose(),this.disposed=!0}}},{"adm-zip":void 0,fs:void 0,https:void 0,os:void 0,path:void 0}],4:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SalesEvent=void 0;const s=e("path"),o=e("fs"),a=e("os"),n=e("vscode"),r=e("./licenseReader"),l=s.join(a.homedir(),".quokka","state.json"),c=[{saleName:"May Sale",discount:50,start:new Date(Date.UTC(2024,4,8,0,0,0,0)).getTime(),end:new Date(Date.UTC(2024,4,15,0,0,0,0)).getTime()},{saleName:"May Sale",discount:40,start:new Date(Date.UTC(2024,4,15,0,0,0,0)).getTime(),end:new Date(Date.UTC(2024,4,22,0,0,0,0)).getTime()}];class d{constructor(e,t){this.disposable=void 0,this.disposed=!1,this.gift=void 0;const i=c.reduce((e,t)=>((void 0===e.start||e.start>t.start)&&(e.start=t.start),(void 0===e.end||e.end<t.end)&&(e.end=t.end),e),{start:void 0,end:void 0});this.start=new Date(i.start),this.end=new Date(i.end),this.nextCheckTime=void 0,this.buildDate=e||new Date,this.gift=t,this.setup()}setup(){if(n.env.remoteName)return;const e=r.LicenseReader.getLicenseDetails(this.buildDate);e&&!e.newInstall&&"activated"!==e.state&&new Date<=this.end&&(this.nextCheckTime=this.getNextCheckTime(),this.nextCheckTime<this.end&&(this.checkAndShowMessage(),this.disposable=n.window.onDidChangeActiveTextEditor(()=>{this.checkAndShowMessage()})))}saleInProgress(){const e=new Date;return e>this.start&&e<this.end}checkAndShowMessage(){const e=r.LicenseReader.getLicenseDetails(this.buildDate);if(!e||"activated"!==e.state&&"activating"!==e.state){const t=new Date,i=()=>!this.disposed&&t>this.start&&t<this.end&&this.nextCheckTime&&t>=this.nextCheckTime;i()&&(this.nextCheckTime=this.getNextCheckTime(),i()&&this.showMessageAndHandleUserResponse(e))}else this.setNextCheckTimeToEndDate(),this.dispose()}discountAmount(){const e=(new Date).getTime(),t=c.find(t=>e>=t.start&&e<t.end);return t?t.discount:0}showMessageAndHandleUserResponse(e){const t=this.nextCheckTime;this.nextCheckTime=this.setNextCheckTime();const i="expiring"===e.state,s=(new Date).getTime(),o=c.find(e=>s>=e.start&&s<e.end);if(!o)return;if(i&&o.discount<=30)return;const a=(i?"Renew":"Get")+` Quokka.js Pro 🚀 today with our limited time ${o.discount}% ${o.saleName?o.saleName+" ":""}discount!`;try{const e=d.readStateFile();t.getTime()>c[0].start||e.lastUrlOpen&&e.lastUrlOpen>c[0].start&&!e.th?(d.updateStateFile({th:(new Date).getTime()}),n.window.showInformationMessage("We saw you recently looked at Quokka 'PRO' and prepared a short 🎁 treasure hunt 🎁 for you!",{title:"Start Adventure",gift:!0},{title:"Don't show again",dontShow:!0}).then(e=>this.handleUserResponse(e))):n.window.showInformationMessage(a,{title:"Buy License",url:n.Uri.parse("https://wallabyjs.com/store/personal/?referrer=qsp#select-quokka")},{title:"Read More",url:n.Uri.parse("https://quokkajs.com/pro/?referrer=qsp")},{title:"Don't show again",dontShow:!0}).then(e=>this.handleUserResponse(e))}catch(e){}}handleUserResponse(e){e&&(e.dontShow?(this.setNextCheckTimeToEndDate(),this.dispose()):e.url?(this.setLastUrlOpenedTime(),n.commands.executeCommand("vscode.open",e.url)):e.gift&&(this.setNextCheckTimeToEndDate(),this.dispose(),this.gift&&this.gift()))}static updateStateFile(e){let t;try{t=Object.assign(Object.assign({},JSON.parse(o.readFileSync(l).toString())),e)}catch(i){t=Object.assign({},e)}try{o.writeFileSync(l,JSON.stringify(t))}catch(e){}}static readStateFile(){try{return JSON.parse(o.readFileSync(l).toString())}catch(e){return{}}}setNextCheckTimeToEndDate(){d.updateStateFile({nextCheck:this.end})}setLastUrlOpenedTime(){if(new Date>=this.start){const e=new Date,t=new Date(e.setDate(e.getDate()+1));d.updateStateFile({lastUrlOpen:(new Date).getTime(),nextCheck:t})}}deleteStateConfig(){try{o.existsSync(l)&&o.unlinkSync(l)}catch(e){}}dispose(){this.disposable&&this.disposable.dispose(),this.disposed=!0}setNextCheckTime(){const e=new Date,t=new Date(e.setDate(e.getDate()+1));return d.updateStateFile({nextCheck:t}),t}getNextCheckTime(){try{if(o.existsSync(l)){const e=o.readFileSync(l).toString(),t=JSON.parse(e);return t.nextCheck?new Date(t.nextCheck):(d.updateStateFile({nextCheck:this.start}),this.start)}return d.updateStateFile({nextCheck:this.start}),this.start}catch(e){return this.deleteStateConfig(),this.setNextCheckTimeToEndDate(),this.end}}}i.SalesEvent=d},{"./licenseReader":8,fs:void 0,os:void 0,path:void 0,vscode:void 0}],5:[function(e,t,i){"use strict";let s,o;function a(){o.forEach(e=>{try{e(s)}catch(e){}}),o=void 0}Object.defineProperty(i,"__esModule",{value:!0}),i.checkForOffers=void 0,i.checkForOffers=function(t){if(s&&t(s),o)return void o.push(t);o=[t];const i=e("https"),n=JSON.stringify({product:"quokka"}),r={hostname:"x55r2pae4l.execute-api.us-east-1.amazonaws.com",port:443,path:"/Prod/checkOffers",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(n)}},l=i.request(r,e=>{let t="";e.on("data",e=>{t+=e}),e.on("end",()=>{200===e.statusCode&&(s=JSON.parse(t),a())})});l.on("error",e=>{console.error(e),s={},a()}),l.write(n),l.end()}},{https:void 0}],6:[function(e,t,i){"use strict";t.exports=class{constructor(){this._disposables=[]}add(e){e.dispose?this._disposables.push(e):this._disposables.push({dispose:e})}dispose(){this._disposables.forEach(e=>e.dispose())}}},{}],7:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function r(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,r)}l((s=s.apply(e,t||[])).next())})};const o=e("path"),a=e("fs"),n=e("os"),r=e("vscode"),l=e("crypto"),c=global._,d=e("./SalesEvent"),u=e("./InteractiveExamples"),h=global.EventEmitter,p=e("./valueExplorer"),_=e("./traceExplorer"),g=e("./recentFilesExplorer"),m=e("./compositeDisposable"),v=e("./outputBuilder"),f=e("./startViewPanel"),k=r.workspace,S=r.window,y=300,w=3500,C="quokka",x="const chest = require('quokka-treasure-chest')",b="​",T=new RegExp("(\\s|^){\\s*{","gm"),D=new RegExp("(?<!>\\s*)^\\s*{\\s*{\\s*$","gm"),E=new RegExp("}\\s*}","gm"),L=["showOutput","createFile","newJavaScript","newTypeScript","newRecentInteractive","makeQuokkaFromExistingFile","runOnSave","runOnce","toggle","createJavaScriptFile","createTypeScriptFile",,"openStartView","showInstrumentedFile","stopCurrent","stopAll","installMissingPackageToProject","installMissingPackageToQuokka","installQuokkaPlugin","goToLineInQuokkaFile","showLicense","switchToPro","switchToCommunity","selectWorkspaceFolder","addImport","addRequire","showValue","copyValue","showLineValues","showLineTimings","copyExpressionPath","copyExpressionData","profile","clearValue","clearFileValues","enableShowValueOnSelection","disableShowValueOnSelection","enableShowSingleInlineValue","disableShowSingleInlineValue","viewRecentFiles","runRecentFile","removeRecentFiles","disableAutoLog","enableAutoLog","revealInValueExplorer","stopShowingOutputCodeLens","editSessionSettings","debug","debugAutoPlay","playTraceNextStep","playTracePrevStep","playTraceNextStepOut","playTracePrevStepOut","playTraceNextStepOver","playTracePrevStepOver","playTraceForwardToSelection","playTraceBackwardToSelection","playTraceForwardToBreakpoint","playTraceBackwardToBreakpoint","viewCallStack","hideCallStack","openCallStackFrame","revealTraceStep","stopTraceNavigation","autoPlayCode","pauseCodeExecution","viewCodeStory","share","allowFileSnapsExecution","insertSnapOutput","deleteSnapOutput","stopFileSnapsDiscovery","startFileSnapsDiscovery","selectAction","showLogs"],P=new Set(["javascript","javascriptreact","typescript","typescriptreact","vue","svelte"]),O={javascript:".js",javascriptreact:".js",plaintext:".js",typescript:".ts",typescriptreact:".tsx",vue:".vue",svelte:".svelte"},q={".js":"javascriptreact",".jsx":"javascriptreact",".ts":"typescript",".tsx":"typescriptreact",".vue":"vue",".svelte":"svelte"},A={automatic:0,onsave:1,once:2,snapsOnly:3},N=" Quokka",F=new Set(["`","'",'"',")","}","]"]);let R=0;class I extends h{constructor(e){super();let t=this;this._state=e,this._context=e.context,this._deactivator=e.deactivate,this._Session=e.coreClient.Session,this._utils=e.coreClient.utils,this._buildDate=new Date(e.coreClient.bd),this._outputDocumentSelector={language:"quokka-output"},this._setupVersionSpecificComponents(e.version),this._statusBarItem=S.createStatusBarItem(r.StatusBarAlignment.Right),this._statusBarItem.show(),this._resetStatusBar(),this._disposables=new m,this._syncSettings(),c.each(L,e=>t._disposables.add(r.commands.registerCommand(`quokka.${e}`,(...i)=>{try{return t[e](...i)}catch(e){console.error(e)}}))),r.commands.executeCommand("setContext","quokka.isLiveShareClient",!1),this._initializeCoverageDecorationTypes(),t._disposables.add(r.workspace.onDidChangeConfiguration(()=>{t._reInitializeCoverageDecorationTypes(),t._activeSessions.forEach(e=>e.output.refreshHeaderCommands())})),this._debugOutputChannel={appendLine:(e,t)=>{console.log("%c "+e,"color: "+("error"===t?"red":"darkgreen"))}},this._activeSessions=[],this._activeSession=null,this._activeLicenseSession=null,r.commands.executeCommand("setContext","quokka.hasActiveSession",!1),t._disposables.add(k.onDidChangeTextDocument(e=>{if(e&&e.document&&"quokka-output"===e.document.languageId){const t=S.visibleTextEditors.find(t=>t.document===e.document);t&&(t.selection=new r.Selection(0,0,0,0))}})),t._disposables.add(k.onDidOpenTextDocument(e=>{if(e&&e.uri&&"output"===e.uri.scheme){const t=(e,t)=>{if("quokka-output"===e.languageId)return;const i=e.lineAt(0);if(i&&i.text&&i.text.length)return 0===i.text.indexOf(b);t&&t()};t(e,()=>{const i=k.onDidChangeTextDocument(s=>{s.document===e&&(i.dispose(),t(s.document)&&r.languages.setTextDocumentLanguage(e,"quokka-output"))})})&&r.languages.setTextDocumentLanguage(e,"quokka-output")}})),this.outputChannel=this._createOutputChannel(),this.outputChannel.append(b),t._disposables.add(S.onDidChangeActiveTextEditor(e=>{let i=!1;if(e){var s=this._activeSessions.find(t=>e.document===t.textDocument);s?(this._checkAndSyncSession(s)||this._updateStatusBarForActiveSession(s,!1),r.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!0),i=!0,delete s.activeLineNumber,delete s.activeLineNumberCapturedInCodeStoryViewer,s.activeLineNumber=e.selection&&e.selection.active.line,s.activeLineNumberCapturedInCodeStoryViewer=s.traceExplorer.isCodeStoryViewer(e),t._setInlineValuesFileContext(s.hasRemovableMessages),t._setShowValueOnSelectionEnabledContext(s.showValueOnSelection),t._setShowSingleInlineValueEnabledContext(s.showSingleInlineValue),t._setAutoLogEnabledContext(s.autoLog)):this._registerBackgroundSession(e)}i||r.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!1)})),this._setupEnvironment(),r.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!1),this._valueExplorer=new p(this._context),this._recentFilesExplorer=new g(this._quokkaFolder),this._disposables.add(this._recentFilesExplorer),this.on("started",()=>{this._liveShareClientActive()||r.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!0)}),this._previousInlineValuesLineContext=!1,this._previousInlineValuesFileContext=!1,this._automaticRestartActiveTextEditorHandle=void 0,(this._automaticRestart||this._automaticStartRegex)&&S.visibleTextEditors.forEach(e=>{this._checkForAutomaticStart(e)});const i=()=>{this._automaticRestart=r.workspace.getConfiguration().get("quokka.automaticRestart"),this._automaticStartRegex=r.workspace.getConfiguration().get("quokka.automaticStartRegex"),this._showValueOnMultilineSelection=r.workspace.getConfiguration().get("quokka.showValueOnMultilineSelection",!1);try{this._automaticStartRegex&&(this._automaticStartRegex=new RegExp(this._automaticStartRegex))}catch(e){this._automaticStartRegex=""}!this._automaticRestart&&!this._automaticStartRegex||this._automaticRestartActiveTextEditorHandle?this._automaticRestart||this._automaticStartRegex||!this._automaticRestartActiveTextEditorHandle||(this._automaticRestartActiveTextEditorHandle.dispose(),this._automaticRestartActiveTextEditorHandle=void 0):this._automaticRestartActiveTextEditorHandle=S.onDidChangeActiveTextEditor(e=>{this._checkForAutomaticStart(e)})};this._disposables.add(()=>{this._automaticRestartActiveTextEditorHandle&&this._automaticRestartActiveTextEditorHandle.dispose()}),i(),r.workspace.onDidChangeConfiguration&&this._disposables.add(r.workspace.onDidChangeConfiguration(()=>{i()})),this._setupLiveSharing(),r.commands.executeCommand("setContext","quokka.debug",r.workspace.getConfiguration()&&r.workspace.getConfiguration().get("quokka.debug",!1)),this._reportTelemetry(),this._backgroundSessions=[],this._filesWithSnapsDiscoveryPaused=new Set,this._filesWithSnapsDiscoveryDisabled=new Set,this._resetStatusBar(),this._registerBackgroundSession(S.activeTextEditor),this._disposables.add(r.window.tabGroups.onDidChangeTabs(e=>{e.closed.length&&!r.window.tabGroups.all.flatMap(e=>e.tabs).length&&this._resetStatusBar()}))}_reportTelemetry(){return s(this,void 0,void 0,function*(){const t=o.join(n.homedir(),".quokka",".qts");if(a.existsSync(o.dirname(t))&&!a.existsSync(t))try{const i=e("querystring"),s=e("http"),l=e("uuid"),c=r.workspace.getConfiguration().get("quokka.showStartViewOnFeatureRelease",!0),d=this._context.globalStorageUri.fsPath,u=o.dirname(d),h=o.join(u,"state.vscdb");let p="dndUnknown";if(a.existsSync(h))try{const t=e("sql.js"),i=a.readFileSync(h);p="dndFalse";const s=new((yield t()).Database)(i).prepare("SELECT value FROM ItemTable WHERE key = 'notifications.doNotDisturbMode';");if(s.step()){p="true"===s.getAsObject().value?"dndTrue":"dndFalse"}}catch(e){}const _=`vscode.${this._pro?"pro":"community"}.${p}.${c?"featureNotify":"featureDoNotNotify"}`,g=o.join(n.homedir(),".quokka",".qid");let m;try{m=a.readFileSync(g).toString()}catch(e){m=l.v4();try{a.writeFileSync(g,m)}catch(e){}}const v="UA-58409118-8",f=i.stringify({v:1,tid:v,cid:m,t:"event",ec:_,ea:_,el:_}),k={hostname:"www.google-analytics.com",path:"/collect",method:"POST",headers:{"Content-Length":f.length}},S=s.request(k,function(e){e.on("data",()=>{}),e.on("end",()=>{})});S.on("error",()=>{}),S.write(f),S.end()}catch(e){}finally{a.writeFileSync(t,"")}})}_syncSettings(){const e="quokka.syncSettings";if(this._context.globalState.setKeysForSync([e]),r.workspace.getConfiguration().get("quokka.syncSettings",!0))try{const t="~/.quokka/.vscode.settings",i=[t,"~/.quokka/.qid","~/.quokka/.qlc","~/.quokka/config.json","~/.quokka/notifications.json","~/.quokka/startPage.json","~/.quokka/user.data","~/.quokka/user.id","~/.wallaby/.ol"];let s=n.homedir();s.endsWith(o.sep)||(s+=o.sep);const r=e=>{try{if(e=e.replace("~",s),a.existsSync(e))return a.readFileSync(e,"utf8")}catch(e){}},l=(e,t)=>{try{e=e.replace("~",s),a.existsSync(o.dirname(e))||a.mkdirSync(o.dirname(e),{recursive:!0}),a.writeFileSync(e,t,"utf8")}catch(e){}},c=()=>i.map(e=>({fileName:e,content:r(e)})),d=()=>{l(t,(new Date).getTime().toString()),this._context.globalState.update(e,c())},u=e=>{e.forEach(({fileName:e,content:t})=>{void 0!==t&&l(e,t)})},h=this._context.globalState.get(e);if(h){const e=parseInt(r(t)||"0",10),i=parseInt(h.find(e=>e.fileName===t).content,10);e<i?u(h):e>i?d():JSON.stringify(h)!==JSON.stringify(c())&&d()}else d()}catch(e){}}static _hash(e){return l.createHash("md5").update(e).digest("hex").substr(0,16)}_checkForAutomaticStart(e){if(e&&e.document&&"file"===e.document.uri.scheme){const t=o.extname(e.document.uri.fsPath);if(!q[t])return;const i=this._activeSessions.find(t=>t.textDocument===e.document);if(this._automaticStartRegex)try{return void(!i&&this._automaticStartRegex.test(e.document.uri.fsPath)&&this.makeQuokkaFromExistingFile())}catch(e){}this._automaticRestart&&(i&&i.mode===A.automatic?this._context.workspaceState.update("quokka:runningstate:"+I._hash(e.document.uri.fsPath),1):this._context.workspaceState.get("quokka:runningstate:"+I._hash(e.document.uri.fsPath))&&this.makeQuokkaFromExistingFile())}}_createOutputChannel(){return S.createOutputChannel("Quokka")}_showOutputChannel(){this.outputChannel.hide(),this.outputChannel.show(!0)}_initializeCoverageDecorationTypes(){this._coverageDecorationTypes={1:this._createCoverageDecorationType("notCovered","log"),2:this._createCoverageDecorationType("covered","log"),3:this._createCoverageDecorationType("partiallyCovered","log"),4:this._createCoverageDecorationType("errorSource","error"),5:this._createCoverageDecorationType("errorPath","log"),6:this._createCoverageDecorationType("notCovered","system"),7:this._createCoverageDecorationType("covered","system"),8:this._createCoverageDecorationType("partiallyCovered","system"),9:this._createCoverageDecorationType("errorSource","error"),10:this._createCoverageDecorationType("errorPath","system"),systemLog:S.createTextEditorDecorationType({isWholeLine:!0,rangeBehavior:1,light:{after:this._getThemableDecorationRenderOptions("system","light")},dark:{after:this._getThemableDecorationRenderOptions("system","dark")}})},this._coverageOverrideState=this._currentCoverageOverrideState()}_currentCoverageOverrideState(){const e=r.workspace.getConfiguration();return JSON.stringify([e.get("quokka.lightTheme.log.decorationAttachmentRenderOptions",{}),e.get("quokka.lightTheme.error.decorationAttachmentRenderOptions",{}),e.get("quokka.darkTheme.log.decorationAttachmentRenderOptions",{}),e.get("quokka.darkTheme.error.decorationAttachmentRenderOptions",{})])}_reInitializeCoverageDecorationTypes(){this._coverageOverrideState!==this._currentCoverageOverrideState()&&(this._activeSessions.forEach(e=>{this._clearDecorations(e)}),this._initializeCoverageDecorationTypes(),this._activeSessions.forEach(e=>{this._updateDocuments(e,e.documentUpdates)}))}_liveShareUrlMatches(e,t){if(e.path.startsWith("/~untitled")&&t.path.startsWith("/~untitled")){const t=e.path.split("/"),i=e.path.split("/");return t[t.length-1]===i[i.length-1]}return 0===e.scheme.localeCompare(t.scheme)&&0===e.path.localeCompare(t.path)}_setupLiveSharing(){return s(this,void 0,void 0,function*(){let t,i,o,a;try{t=e("vsls"),i=yield t.getApi(),o="quokkajs"}catch(e){a=e}if(!i)return void this._debugOutputChannel.appendLine("Quokka.js Live Share integration disabled, VSLS not found."+(a?" "+a.message:""));if(this._liveShare={api:i},this._liveShare.server=yield i.shareService(o),this._liveShare.client=yield i.getSharedService(o),!this._liveShare.server||!this._liveShare.client)return this._debugOutputChannel.appendLine('Could not create a shared service. You have to set "liveshare.features" to "experimental" in your user settings in order to use live sharing.'),void delete this._liveShare;this._disposables.add(()=>i&&i.unshareService(o));const n=()=>c.uniq(this._activeSessions.map(e=>({file:e.liveShareFileName,language:e.textDocument.languageId,originalFile:e.textDocument.uri,fileName:e.fileName,documentUpdates:e.documentUpdates,stats:e.stats,mode:e.mode,headerData:e.headerData,liveConsoleOutput:e.allLiveConsoleOutput,status:e.status}))),l=e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.document.uri));if(t){this._start(e.document,e,t.mode);const i=h(t.file);this.processStarted(i),i.output.setHeaderData(t.headerData),i.headerData=t.headerData,t.documentUpdates[t.file.path]=t.documentUpdates[t.fileName],delete t.documentUpdates[t.fileName],this._updateDocuments(i,t.documentUpdates),i.stats=t.stats,i.status=t.status,this.processStats(i),i.liveConsoleOutput=t.liveConsoleOutput,i.liveConsoleOutput&&i.liveConsoleOutput.length&&this._displayLiveConsoleOutput(i,i.liveConsoleOutput),this._liveShare.activeServerSessions=this._liveShare.activeServerSessions.filter(e=>e!==t)}};this._liveShare.api.onDidChangePeers(e=>s(this,void 0,void 0,function*(){this._liveShareServerActive()&&e.added.length&&(this._liveShare.serverAllowed||this._activeSessions.length&&(S.showWarningMessage("You have not given permission to run Quokka.js in your Live Share Session. All Quokka.js instances have been stopped."),this.stopAll(!0)))})),this._context.subscriptions.push(this._liveShare.server.onDidChangeIsServiceAvailable(e=>s(this,void 0,void 0,function*(){e?(this._activeSessions.forEach(e=>{e.liveShareFileName=this._getLiveShareFileName(e.textDocument.uri)}),this._liveShare.disposable=new m,this._liveShare.disposable.add(()=>delete this._liveShare.serverAllowed),this._liveShare.serverAllowed=!1,this._activeSessions.length&&this._showLiveShareWarningMessage()):(this._liveShare.disposable&&this._liveShare.disposable.dispose(),delete this._liveShare.disposable)})));const d=e=>s(this,void 0,void 0,function*(){e?(r.commands.executeCommand("setContext","quokka.isLiveShareClient",!0),r.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!1),this._liveShare.disposable=new m,this._liveShare.disposable.add(()=>delete this._liveShare.activeServerSessions),this._liveShare.disposable.add(S.onDidChangeActiveTextEditor(e=>l(e))),this._liveShare.activeServerSessions=yield this._liveShare.client.request("init",[])):(r.commands.executeCommand("setContext","quokka.isLiveShareClient",!0),this._liveShare.disposable&&this._liveShare.disposable.dispose(),delete this._liveShare.disposable)});this._liveShare.client.isServiceAvailable&&d(!0),this._context.subscriptions.push(this._liveShare.client.onDidChangeIsServiceAvailable(d));const u=e=>S.visibleTextEditors.find(t=>this._liveShareUrlMatches(e,t.document.uri)),h=e=>this._activeSessions.find(t=>{if(e.path.startsWith("/~untitled")&&t.fileName.startsWith("/~untitled")){const i=e.path.split("/"),s=t.fileName.split("/");return i[i.length-1]===s[s.length-1]}return t.fileName===e.path});this._liveShare.server.onRequest("init",()=>n()),this._liveShare.client.onNotify("busy",e=>{const t=h(e.file);t&&this.processSessionBusy(t)}),this._liveShare.client.onNotify("stopped",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file));t&&this._liveShare.activeServerSessions.filter(e=>e!==t);const i=h(e.file);i&&this._stop(i)}),this._liveShare.client.onNotify("started",e=>{const t=u(e.file);if(!t){return void(this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file))||this._liveShare.activeServerSessions.push({file:e.file,originalFile:e.originalFile,fileName:e.fileName,documentUpdates:{},stats:void 0,status:void 0,mode:e.data.mode,headerData:null}))}this._start(t.document,t,e.data.mode);const i=h(e.file);this.processStarted(i)}),this._liveShare.client.onNotify("stats",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file));t&&(t.stats=e.data,delete t.status,delete t.liveConsoleOutput,delete t.allLiveConsoleOutput);const i=h(e.file);i&&(i.stats=e.data,delete i.status,delete i.liveConsoleOutput,delete i.allLiveConsoleOutput,this.processStats(i))}),this._liveShare.client.onNotify("documentUpdates",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(e.file,t.file));t&&(t.documentUpdates=e.data);const i=h(e.file);i&&(e.data[i.fileName]=e.data[e.fileName],delete e.data[e.fileName],this._updateDocuments(i,e.data))}),this._liveShare.client.onNotify("consoleOutput",e=>{const t=h(e.file);t&&this._displayLiveConsoleOutput(t,e.data)}),this._liveShare.client.onNotify("configChanged",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(e.file,t.file));t&&(t.headerData=e.data);const i=h(e.file);i&&(i.output.setHeaderData(e.data),i.headerData=e.data)})})}_changePro(e){this._pro=e,r.commands.executeCommand("setContext","quokka.isPro",!!e)}_checkCountry(){const t=parseInt(this._context.globalState.get("quokka.lastCountryCheck","0"),10),i=Date.now();if(i-t>5184e6){e("./checkOffers").checkForOffers(e=>{e&&e.country&&(this._context.globalState.update("quokka.country",e.country),this._context.globalState.update("quokka.lastCountryCheck",i.toString()))})}}_setupEnvironment(){this._quokkaFolder=o.join(n.homedir(),".quokka"),this._wallabyFolder=o.join(n.homedir(),".wallaby"),this._lkp=o.join(this._quokkaFolder,".qlc"),this._ol=o.join(this._wallabyFolder,".ol");try{a.existsSync(this._quokkaFolder)||a.mkdirSync(this._quokkaFolder)}catch(e){}try{a.existsSync(this._wallabyFolder)||a.mkdirSync(this._wallabyFolder)}catch(e){}const e=this._loadQuokkaConfig();if(this._changePro(!0===e.pro),this._checkCountry(),this._salesEvent=new d.SalesEvent(this._buildDate,()=>this._treasureHunt()),this._interactiveExamples=new u.InteractiveExamples,this._interactiveExamples.initialize(),f.setController(this),!0!==e.pro&&!1!==e.pro)f.createOrShow(this._context,{type:"firstInstall"});else{f.showWhatsNewIfRequired(this._context);let e=!1;this._disposables.add(S.onDidChangeActiveTextEditor(()=>{if(!e){const t=Date.now(),i=Date.UTC(2022,0,26),s=Date.UTC(2022,1,2);t>=i&&t<=s&&(f.showWhatsNewIfRequired(this._context),e=!0)}}))}}_quokkaConfigPath(){return o.join(this._quokkaFolder,"config.json")}_loadQuokkaConfig(){const e=this._quokkaConfigPath();let t,i={};try{t=a.readFileSync(e).toString(),i=JSON.parse(t)}catch(e){t&&S.showWarningMessage("Looks like your quokka config.json file has invalid syntax, it should be a valid JSON file.")}return i}_saveQuokkaConfig(e){a.writeFileSync(this._quokkaConfigPath(),JSON.stringify(e))}_getThemableDecorationRenderOptions(e,t){const i=e,s=r.workspace.getConfiguration().get(`quokka.${t}Theme.${i}.decorationAttachmentRenderOptions`,{color:"light"===t?"error"===i?"#c80000":"log"===i?"#0000ff":new r.ThemeColor("editorCodeLens.foreground"):"error"===i?"#fe536a":"log"===i?"rgba(86, 156, 214, 1)":new r.ThemeColor("editorCodeLens.foreground"),margin:"1.2em"}),o={};return Object.keys(s).forEach(e=>{null!==s[e]&&(o[e]=s[e])}),delete o.contentText,delete o.contentIconPath,o}_createCoverageDecorationType(e,t){return S.createTextEditorDecorationType({isWholeLine:!0,rangeBehavior:1,gutterIconPath:this._context.asAbsolutePath(o.join("images",e+".svg")).split("\\").join("/"),light:{after:this._getThemableDecorationRenderOptions(t,"light")},dark:{after:this._getThemableDecorationRenderOptions(t,"dark")}})}addImport(e){S.activeTextEditor&&I._addCode(S.activeTextEditor,new r.Position(0,0),`import ${e} from '${e}';\n`)}addRequire(e){S.activeTextEditor&&I._addCode(S.activeTextEditor,new r.Position(0,0),`const ${e} = require('${e}');\n`)}static _addCode(e,t,i){const s=new r.WorkspaceEdit;s.insert(e.document.uri,t,i),r.workspace.applyEdit(s)}newJavaScript(){this.createJavaScriptFile()}newTypeScript(){this.createTypeScriptFile()}newRecentInteractive(e){this._runIfAllowed(()=>{const t=[...e?["JavaScript","TypeScript"]:[],{label:"Recent Files",recent:!0},...this._interactiveExamples.getExamples()];S.showQuickPick(t).then(e=>{if(!e)return;if(e.recent)return this.viewRecentFiles();let t="",i=e;e.label?(i=this._interactiveExamples.getLanguage(e),t=this._interactiveExamples.getContent(e),this._createLanguageFile(i,t,o.join("interactive-examples",this._interactiveExamples.getRelativeFilePath(e)))):this._createLanguageFile(i,t)})})}createFile(){this.newRecentInteractive(!0)}profile(){this._activeSession&&S.showQuickPick([{label:"Open profile in Chrome Dev Tools",target:"devtools"},{label:"Open profile in VS Code",target:"editor"}]).then(e=>{e&&e.target&&this._activeSession.runTests({profileRun:e.target,file:this._activeSession.fileName})})}editSessionSettings(){if(!this._activeSession)return;const e=this._activeSession,t=e.showValueOnSelection,i=e.showSingleInlineValue,s=[];e.autoLog?s.push({label:"$(symbol-boolean) Toggle Auto Log (Disable)",command:"quokka.disableAutoLog"}):(s.push({label:"$(symbol-boolean) Toggle Auto Log (Enable)",command:"quokka.enableAutoLog"}),t?s.push({label:"$(symbol-boolean) Toggle Show Expression Value on Selection (Disable)",command:"quokka.disableShowValueOnSelection"}):s.push({label:"$(symbol-boolean) Toggle Show Expression Value on Selection (Enable)",command:"quokka.enableShowValueOnSelection"}),i?s.push({label:"$(symbol-boolean) Show All Selected Values",command:"quokka.disableShowSingleInlineValue"}):s.push({label:"$(symbol-boolean) Show Last Selected Value Only",command:"quokka.enableShowSingleInlineValue"})),S.showQuickPick(s).then(t=>{t&&t.command&&(r.commands.executeCommand(t.command),S.showTextDocument(e.textDocument,{preserveFocus:!1}))})}debug({fromTheStart:e=!1}={fromTheStart:!1}){this._activeSession&&(e&&this.stopTraceNavigation(),this._activeSession.runTests({initialTraceRun:!0,file:this._activeSession.fileName,line:e?void 0:this._activeSession.activeLineNumber+1}))}debugAutoPlay(){this._activeSession&&(this._activeSession.runTests({initialTraceRun:!0,file:this._activeSession.fileName,line:this._activeSession.activeLineNumber+1}),this._activeSession.traceExplorer.autoPlayCodeOnStart())}playTraceNextStep(e={}){this._requestTrace(e)}playTraceNextStepOver(){this._requestTrace({over:!0})}playTraceNextStepOut(){this._requestTrace({out:!0})}playTracePrevStep(){this._requestTrace({back:!0})}playTracePrevStepOver(){this._requestTrace({back:!0,over:!0})}playTracePrevStepOut(){this._requestTrace({back:!0,out:!0})}playTraceForwardToSelection(){this._playTraceToSelection()}playTraceBackwardToSelection(){this._playTraceToSelection({back:!0})}playTraceForwardToBreakpoint(){this._requestTrace({breakpoints:this._getBreakpoints()})}playTraceBackwardToBreakpoint(){this._requestTrace({back:!0,breakpoints:this._getBreakpoints()})}_playTraceToSelection(e={}){const t=this._activeSession;if(!t)return;const i=S.activeTextEditor;if(i){if(e.line=t.activeLineNumber+1,e.file=t.fileName,t.traceExplorer.isCodeStoryViewer(i)||t.activeLineNumberCapturedInCodeStoryViewer){const i=t.traceExplorer.getOriginalLocationByCodeStoryLine(e.line);if(!i)return;e.line=i.line,e.file=i.file,e.frame=i.step}this._requestTrace(e)}}_getBreakpoints(e){return e||(e=this._activeSession),r.debug.breakpoints&&e&&e.textDocument?r.debug.breakpoints.filter(t=>t.enabled&&t.location&&t.location.range&&t.location.uri&&t.location.uri.toString()===e.textDocument.uri.toString()).map(t=>({line:t.location.range.start.line+1,file:e.fileName})):[]}_requestTrace(e={}){this._activeSession&&this._activeSession.traceExplorer.requestTrace(e).then(t=>this._processTraceNavigation(this._activeSession,t,!1,e.preserveTimelineSelection))}showOutput(){this._activeSession&&this.outputChannel&&this._showOutputChannel()}createJavaScriptFile(){this._runIfAllowed(()=>this._createLanguageFile("JavaScript"))}createTypeScriptFile(){this._runIfAllowed(()=>this._createLanguageFile("TypeScript"))}makeQuokkaFromExistingFile(){this._runIfAllowed(()=>this._runFromExistingFile(A.automatic))}toggle(){const e=S.activeTextEditor;if(!e)return;const t=e.document;t&&(this._activeSessions.find(e=>e.textDocument===t)?this.stopCurrent():this.makeQuokkaFromExistingFile())}share(){return s(this,void 0,void 0,function*(){const e=this._activeSession;if(!e)return;const t=this._context.secrets;let i=yield t.get("quokka.codeClipEditorId");i||(i=l.randomBytes(32).toString("hex"),yield t.store("quokka.codeClipEditorId",i));const s=r.workspace.getConfiguration(),o=()=>{r.window.withProgress({location:r.ProgressLocation.Notification,title:"Sharing Quokka",cancellable:!1},t=>{const s=R++;let o;return e.tasks||(e.tasks={}),e.tasks[s]=((i,a)=>{switch(i){case"completion":delete e.tasks[s],o();break;case"failure":delete e.tasks[s],o(),setTimeout(()=>S.showErrorMessage(a),1e3);break;case"progress":t.report({message:a})}}),t.report({message:"Preparing"}),e.shareCodeClip(i,s),new Promise(e=>o=e)})};if(s.get("quokka.codeClipAutoUpload",!1))o();else{const t=yield S.showWarningMessage("Are you sure that you want to share the code and its output on codeclip.io?",{title:"Yes",allow:!0},{title:"No",allow:!1},{title:"Always Yes",allow:!0,always:!0});t&&t.allow&&(t.always&&s.update("quokka.codeClipAutoUpload",!0,!0),this._activeSession===e&&o())}})}runOnSave(){this._pro?this._runIfAllowed(()=>this._runFromExistingFile(A.onsave)):this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession)}runOnce(){this._pro?this._runIfAllowed(()=>{const e=S.activeTextEditor;if(!e)return;const t=e.document;if(!t)return;const i=this._activeSessions.find(e=>e.textDocument===t);i&&i.mode===A.once?i.changes.length?this._processDocumentContentChange(i,t,[],!0):i.runTests({file:i.fileName}):this._runFromExistingFile(A.once)}):this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession)}stopCurrent(){const e=S.activeTextEditor,t=e&&e.document&&this._activeSessions.find(t=>t.textDocument===e.document)||this._activeSession;t&&this._stop(t,{setAutomaticStateOff:!0})}stopAll(e){this._activeSessions.slice().forEach(t=>this._stop(t,{setAutomaticStateOff:!e}))}showInstrumentedFile(){this._activeSession&&this._activeSession.requestInstrumentedFile({path:this._activeSession.fileName},e=>{this._activeSession.output.clearAndRenderHeader(),this._activeSession.output.appendConsoleMessage({text:e,type:"warn"})})}installMissingPackageToProject(){this._installPackage(!0)}installMissingPackageToQuokka(){this._installPackage()}installQuokkaPlugin(e,t){this._installPackage(!1,e,t)}showValue(){this._showValue("show",!0)}copyValue(){this._showValue("copy")}showLineValues(){this._showLineValues("show")}showLineTimings(){this._showLineValues("time")}clearValue(){this._clearValues("one")}clearFileValues(){this._clearValues("file")}enableShowValueOnSelection(){this._toggleShowValueOnSelection()}disableShowValueOnSelection(){this._toggleShowValueOnSelection()}enableShowSingleInlineValue(){this._toggleShowSingleInlineValue()}disableShowSingleInlineValue(){this._toggleShowSingleInlineValue()}viewRecentFiles(){return this._recentFilesExplorer.show(this._projectRoot())}runRecentFile(e){const t=o.extname(e.path),i=q[t];i&&(e.runInParentProject?(this._context.globalState.update("quokka:runRecentFile",Object.assign(Object.assign({},e),{runInParentProject:!1})),r.commands.executeCommand("vscode.openFolder",r.Uri.file(e.projectRoot),!0)):e.scratchFile?this._createLanguageFile(i,e.content,e.clone?null:e.id):k.openTextDocument(e.resolvedPath).then(e=>S.showTextDocument(e).then(t=>this._start(e,t,A.automatic))))}removeRecentFiles({files:e,reloadRecentFilesView:t}){return s(this,void 0,void 0,function*(){if(yield this._recentFilesExplorer.removeRecentFiles(e),t)return this._recentFilesExplorer.show(this._projectRoot())})}_toggleAutoLog(){if(this._liveShareClientActive())return;const e=this._activeSession;e&&(e.toggleAutoLog(),e.autoLog=!e.autoLog,this._setAutoLogEnabledContext(e.autoLog))}disableAutoLog(){this._toggleAutoLog()}enableAutoLog(){this._toggleAutoLog()}revealInValueExplorer(e){if(this._liveShareClientActive())return;const t=this._activeSession;if(!t)return;let i=1;e?e.loc&&(i=parseInt((e.loc+"").split(":")[0],10)):i=t.activeLineNumber+1,this._valueExplorer.reveal(t.id,i)}stopShowingOutputCodeLens(){return s(this,void 0,void 0,function*(){yield r.workspace.getConfiguration().update("quokka.showCodeLensInOutputChannel",!1,!0),this._activeSessions.forEach(e=>e.output.refreshHeaderCommands())})}_getLogpoints(e){return this._filterBreakpoints(e,r.debug.breakpoints).map(e=>({id:e.id,range:[e.location.range.start.line+1,e.location.range.start.character,e.location.range.end.line+1,e.location.range.end.character],inline:0!==e.location.range.start.character}))}_filterBreakpoints(e,t){const i=e.textDocument.lineCount;return e&&e.textDocument&&t?t.filter(t=>this._breakpointQualifies(e,i,t)):[]}_breakpointQualifies(e,t,i){return i.enabled&&i.location&&i.location.range&&i.location.uri&&i.location.uri.toString()===e.textDocument.uri.toString()&&i.location.range.start.line<t}_pushBreakpointInfo(e,t,i){const s=t.textDocument.lineCount;[...i.added,...i.removed].some(e=>this._breakpointQualifies(t,s,e))&&t.setLogpoints([{path:t.fileName,logpoints:this._getLogpoints(t)}])}_showValue(e,t){const i=S.activeTextEditor;if(!i)return;if(this._liveShareClientActive())return;const s=this._activeSession;if(!s||!s.textDocument)return;const o=i.selection;if(!o||!o.end)return;let a=o.start.line+1,n=o.end.line+1;if(s.traceExplorer.isCodeStoryViewer(i)){this._playTraceToSelection({preserveTimelineSelection:!0,playToExactFrame:!0});const e=s.traceExplorer.getOriginalLocationByCodeStoryLine(a);if(!e)return;const t=n-a;n=(a=e.line)+t}else if(i.document!==s.textDocument)return;const l=s.textDocument.getText();s.evaluateExpressionInEditor(s.fileName,l,[a,o.start.character,n,o.end.character],e),t&&this._scheduleOnResultsAvailable(s.fileName,o.end,()=>r.commands.executeCommand("editor.action.showHover"))}_showLineValues(e){const t=S.activeTextEditor;if(!t)return;if(this._liveShareClientActive())return;const i=this._activeSession;if(!i||!i.textDocument)return;const s=t.selection;if(!s)return;const o=[];for(let e=s.start.line;e<=s.end.line;e++){let s=e+1;if(i.traceExplorer.isCodeStoryViewer(t)){this._playTraceToSelection({preserveTimelineSelection:!0,playToExactFrame:!0});const e=i.traceExplorer.getOriginalLocationByCodeStoryLine(s);if(!e)return;s=e.line}else if(t.document!==i.textDocument)return;o.push([s,0,s,i.textDocument.lineAt(e).text.length])}const a=i.textDocument.getText();i.evaluateExpressionInEditor(i.fileName,a,{ranges:o},e)}_clearValues(e){const t=this._activeSession;if(!t)return;const i={};if(t.messages&&("file"===e||"one"===e)){const s=S.activeTextEditor;if(!s)return;if(i.path=t.fileName,"one"===e){const e=s.selection;if(!e||!e.active)return;const o=s.selection.active.line;if(i.line=o+1,!t.messages[o]||!t.messages[o].removable)return}if("file"===e&&!t.hasRemovableMessages)return;t.removeLogs(i)}}_toggleShowSingleInlineValue(){if(this._liveShareClientActive())return;const e=this._activeSession;e&&(e.toggleShowSingleInlineValue(),e.showSingleInlineValue=!e.showSingleInlineValue,this._activeSessions.forEach(e=>e.output.refreshHeaderCommands()),this._setShowSingleInlineValueEnabledContext(e.showSingleInlineValue))}_toggleShowValueOnSelection(){if(this._liveShareClientActive())return;const e=this._activeSession;e&&(e.showValueOnSelection=!e.showValueOnSelection,this._activeSessions.forEach(e=>e.output.refreshHeaderCommands()),this._setShowValueOnSelectionEnabledContext(e.showValueOnSelection))}_scheduleOnResultsAvailable(e,t,i){this._runOnResultsAvailable={fileName:e,selectionEnd:t,action:i}}_runScheduledActionOnResultsAvailable(){if(!this._runOnResultsAvailable)return;const e=S.activeTextEditor;if(!e)return;const t=this._activeSession;if(!t||!t.textDocument||e.document!==t.textDocument)return;const i=e.selection;if(i&&i.end&&t.fileName===this._runOnResultsAvailable.fileName&&i.end===this._runOnResultsAvailable.selectionEnd)try{this._runOnResultsAvailable.action()}finally{delete this._runOnResultsAvailable}}copyExpressionPath(e){e&&e.copyExpressionPath()}copyExpressionData(e){e&&e.copyExpressionData()}goToLineInQuokkaFile(e,{reveal:t=!0,select:i=!0,focus:s=!0}={reveal:!0,select:!0,focus:!0}){if(!this._activeSession)return;if(!e)return S.showTextDocument(this._activeSession.textDocument,{preserveFocus:!s});let o,a;return c.isArray(e)?(o=e[0]-1,a=e[1]):(e=e.split(","),o=e[0]&&parseInt(e[0],10)-1||0,a=e[1]&&parseInt(e[1],10)||0),S.showTextDocument(this._activeSession.textDocument,{preserveFocus:!s}).then(e=>{if(o>=e.document.lineCount)return;const s=e.document.lineAt(o);a<s.firstNonWhitespaceCharacterIndex&&(a=s.firstNonWhitespaceCharacterIndex);const n=s.range.end.character;if(a>n&&(a=n),!t)return e;const l=new r.Position(o,a);return e.revealRange(new r.Range(l,l)),i?(e.selection=new r.Selection(l,l),e):e})}openStartView(){f.createOrShow(this._context)}_installPackage(e,t,i){if(this._activeSession)if(t)this._activeSession.status="progress",this._updateStatusBarForActiveSession(this._activeSession),this._activeSession.runTests({file:this._activeSession.fileName,installPackage:{name:t,plugin:{editConfig:!0,name:i||t}}});else{if(e&&!this._projectRoot())return void S.showWarningMessage("Cannot install a package into project because quokka is running outside of an opened project.");if(!this._pro)return void this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession);if(!this._activeSession.stats||!this._activeSession.stats.errors)return void S.showWarningMessage("No missing packages to install.");const t=c.find(this._activeSession.stats.errors,e=>e.missingPackage);if(!t||!t.missingPackage)return void S.showWarningMessage("No missing packages to install.");this._activeSession.status="progress",this._updateStatusBarForActiveSession(this._activeSession),this._activeSession.runTests({file:this._activeSession.fileName,installPackage:{name:t.missingPackage,local:e}})}else S.showWarningMessage("Cannot install a package because quokka is not running.")}_setupVersionSpecificComponents(e){const t=e.major,i=e.minor;t>=1&&i>=11&&(this._outputDocumentSelector.scheme="*"),t>=1&&i>=16&&(this._multiFolderWorkspaces=!0)}_createLanguageFile(e,t,i){var s;return(null===(s=S.tabGroups)||void 0===s?void 0:s.onDidChangeTabs)||(t=t||" "),e&&k.openTextDocument({language:e.toLowerCase(),content:t}).then(e=>S.showTextDocument(e).then(t=>this._start(e,t,A.automatic,i)))}_stop(e,t){var i,s,o;if(t=t||{setAutomaticStateOff:!1,restarting:!1},e.mode!==A.snapsOnly&&t.setAutomaticStateOff&&"file"===e.textDocument.uri.scheme){this._context.workspaceState.get("quokka:runningstate:"+I._hash(e.textDocument.uri.fsPath))&&this._context.workspaceState.update("quokka:runningstate:"+I._hash(e.textDocument.uri.fsPath),0)}const a=e.editors&&e.editors[0];if(e.disposable&&e.disposable.dispose(),this._activeSessions=this._activeSessions.filter(t=>t.textDocument&&e.textDocument?t.textDocument!==e.textDocument:t!==e),a&&!t.restarting){if("snaps"===t.initiator){const t={recovered:!0,sticky:null===(i=null===e||void 0===e?void 0:e.metadata)||void 0===i?void 0:i.sticky,counters:{stops:(null===(o=null===(s=null===e||void 0===e?void 0:e.metadata)||void 0===s?void 0:s.counters)||void 0===o?void 0:o.stops)||0}};this._registerBackgroundSession(a,t)}else{const e={hibernated:!0};this._registerBackgroundSession(a,e)}this._liveShareClientActive()&&this._resetStatusBar()}else this._resetStatusBar();c.isEmpty(this._activeSessions)&&(this.emit("allSessionStopped"),r.commands.executeCommand("setContext","quokka.hasActiveSession",!1)),this._recentFilesExplorer.reset()}_relativeNormalizedFilePath(e){return this._utils.normalizePath(o.relative(this._projectRoot(),e))}_runFromExistingFile(e){const t=S.activeTextEditor;if(!t)return;const i=t.document;i&&(O[i.languageId]?this._start(i,t,e,this._getFileId(i)):"output"===i.uri.scheme&&"quokka-output"===i.languageId?this._activeSession&&!this._activeSession.isDisposed()&&this._start(this._activeSession.textDocument,this._activeSession.editors[0],this._activeSession.mode,this._getFileId(this._activeSession.textDocument)):S.showWarningMessage(`Language "${i.languageId}" is not supported`))}_getFileId(e){if(e)try{const t=d.SalesEvent.readStateFile();if((new Date).getTime()-t.th<11232e5)return~e.getText().indexOf(x)?"treasure-hunt":void 0}catch(e){}}_runIfAllowed(e){!this._liveShareServerActive()||this._liveShare.serverAllowed?e():this._showLiveShareWarningMessage(e)}_showLiveShareWarningMessage(e){S.showWarningMessage("When sharing outside read-only mode, the Quokka.js extension will execute CODE WRITTEN BY OTHERS ON YOUR COMPUTER. Select 'Allow' to continue executing Quokka.js during your Live Share Session.",{title:"Allow",allow:!0},{title:"Deny",allow:!1}).then(t=>{this._liveShare.serverAllowed=!(!t||!t.allow),this._liveShare.serverAllowed?e&&e():this._activeSessions.length&&(S.showInformationMessage("All Quokka.js instances have been stopped."),this.stopAll(!0))})}_liveShareClientActive(){return!!(this._liveShare&&this._liveShare.client&&this._liveShare.client.isServiceAvailable)}_liveShareServerActive(){return!!(this._liveShare&&this._liveShare.server&&this._liveShare.server.isServiceAvailable)}_getLiveShareFileName(e){return"file"===e.scheme?this._liveShare.api.convertLocalUriToShared(e):"untitled"===e.scheme?r.Uri.parse(`vsls:${"/~untitled/"+r.workspace.asRelativePath(e,!1)}`):void 0}_sendToLiveShareClients(e,t,i){this._liveShareServerActive()&&this._liveShare.server.notify(e,{file:t.liveShareFileName,originalFile:t.textDocument.uri,fileName:t.fileName,data:i})}_start(e,t,i,s,a){var n;this._updateConfigurationFromSettings(),I._checkConfigurationSettings();const l=this._liveShareClientActive();if(!0!==a&&!l&&!k.isTrusted){switch(r.workspace.getConfiguration().get("quokka.untrustedWorkspaceBehavior","Prompt to allow")){case"Prompt to allow":return void S.showWarningMessage("You are running in an untrusted workspace. Are you sure you want to start Quokka.js and execute files in this workspace?","Yes","No","Open Settings").then(o=>{"Open Settings"===o?r.commands.executeCommand("workbench.action.openSettings","quokka.untrustedWorkspaceBehavior"):"Yes"===o&&this._start(e,t,i,s,!0)});case"Never allow":return void S.showErrorMessage("Cannot start Quokka.js as it is currently configured to not allow starting in untrusted workspaces.","Open Settings").then(e=>{"Open Settings"===e&&r.commands.executeCommand("workbench.action.openSettings","quokka.untrustedWorkspaceBehavior")})}}const d=l?{}:new this._Session;if(!l){const t=this._backgroundSessions.find(t=>t.document===e);this._backgroundSessions=this._backgroundSessions.filter(e=>e!==t),t&&i===A.snapsOnly&&(d.metadata=t.metadata),null===t||void 0===t||t.disposable.dispose()}if(l)d.isDisposed=(()=>!1),d.stop=(()=>{});else{const t=this._activeSessions.find(t=>t.textDocument===e);t&&this._stop(t,{restarting:!0})}const u=new m;if(this._activeSession&&this._activeSession.output.disableChannel(),u.add(()=>{this._sendToLiveShareClients("stopped",d)}),u.add(()=>{this._valueExplorer.remove(d)}),u.add(()=>{delete this._runOnResultsAvailable}),this._watcher||l||(this._watcher=k.createFileSystemWatcher("**/*.*"),this._disposables.add(this._watcher)),!l){u.add(r.languages.registerHoverProvider(e.languageId,{provideHover:(t,i)=>{if(t===e&&d.snaps&&(!d.changeTs||d.changeTs<d.updateTs)){const e=d.snaps.lines[i.line];if(e){const t=[];d.metadata&&!d.metadata.permissive?t.push(this._makeHoverIcon("quokka.allowFileSnapsExecution","Allow snap(s) execution until file is closed","run-all")):e.output?t.push(this._makeHoverIcon("quokka.deleteSnapOutput","Delete snap output","clear-all",i.line)):t.push(this._makeHoverIcon("quokka.insertSnapOutput","Insert snap output","insert",i.line));const s=`<table><tr><td>Quokka Snaps Detected${t.length?"&nbsp;&nbsp;&nbsp;":""}</td><td align='right'>${t.join("&nbsp;&nbsp;")}</td></tr></table>`,o=new r.MarkdownString(s);return o.supportHtml=!0,o.isTrusted=!0,new r.Hover(o)}}}})),u.add(r.languages.registerHoverProvider(e.languageId,{provideHover:(t,i)=>{if(t===e&&!c.isEmpty(d.errors)&&(!d.changeTs||d.changeTs<d.updateTs)){const e=(d.errors[i.line]||{}).hover;if(!e)return;return new r.Hover(e.value)}}}));const t=new r.CodeAction("Allow snap(s) execution until file is closed",r.CodeActionKind.Empty);t.command={command:"quokka.allowFileSnapsExecution",title:""};const i=new r.CodeAction("Insert snap output",r.CodeActionKind.Empty);i.command={command:"quokka.insertSnapOutput",title:""};const s=new r.CodeAction("Delete snap output",r.CodeActionKind.Empty);s.command={command:"quokka.deleteSnapOutput",title:""},u.add(r.languages.registerCodeActionsProvider(e.languageId,{provideCodeActions:(o,a)=>{var n;if(o===e&&(!c.isEmpty(d.errors)||d.snaps)&&(!d.changeTs||d.changeTs<d.updateTs)){let e=[];const o=null===(n=d.snaps)||void 0===n?void 0:n.lines[a.start.line];if(o&&(d.metadata&&!d.metadata.permissive?e.push(t):o.output?o.output.range&&e.push(s):e.push(i)),d.errors){const t=(d.errors[a.start.line]||{}).commands;t&&(e=e.concat(t))}return e}}}))}if(d.mode=i,d.disposable=u,d.textDocument=e,d.changes=[],d.fileName=C+O[e.languageId],d.fileId=s,d.documentUpdates={},(i===A.automatic||i===A.snapsOnly)&&!l){const e=e=>{d.textDocument.uri.path!==e.path&&"progress"!==d.status&&d.runTests({file:d.fileName,externalFileChange:!0,externalFileChangePath:e.fsPath})};u.add(this._watcher.onDidCreate(e)),u.add(this._watcher.onDidChange(e)),u.add(this._watcher.onDidDelete(e))}let h;if("file"===e.uri.scheme){const t=e.uri.path.split("/");h=t[t.length-1]}else if("vsls"===e.uri.scheme){const t=e.uri.path.split("/");h=t[t.length-1]}else h=e.uri.path+O[e.languageId];if(d.id=h,"file"===e.uri.scheme)if(this._projectRoot(e.uri.fsPath)){const t=this._relativeNormalizedFilePath(e.uri.fsPath);t&&(d.fileName=t)}else d.localRoot=o.dirname(e.uri.fsPath),d.fileName=o.basename(e.uri.fsPath);else void 0===d.fileId&&this._recentFilesExplorer.findRecentScratchFileIdByContent(e.getText()).then(e=>{d.fileId=e});this._liveShareServerActive()&&(d.liveShareFileName=this._getLiveShareFileName(e.uri)),"vsls"===e.uri.scheme&&l&&(d.fileName=e.uri.path),d.editors=[t],d.liveConsoleOutput=[],d.allLiveConsoleOutput=[],d.activeLineNumber=t.selection&&t.selection.active.line,this._activeSessions.push(d),r.commands.executeCommand("setContext","quokka.hasActiveSession",!0),u.add(r.debug.onDidChangeBreakpoints(e=>{this._updateBreakpointsContext(d),this._pushBreakpointInfo(t,d,e)})),(null===(n=S.tabGroups)||void 0===n?void 0:n.onDidChangeTabs)?u.add(S.tabGroups.onDidChangeTabs(()=>{S.tabGroups.all.flatMap(e=>e.tabs).some(t=>{var i,s;return(null===(s=null===(i=t.input)||void 0===i?void 0:i.uri)||void 0===s?void 0:s.fsPath)===e.uri.fsPath})||this._stop(d)})):u.add(k.onDidCloseTextDocument(t=>{e===t&&this._stop(d)})),u.add(k.onDidChangeTextDocument(t=>{const i=this._applyingInlineOutputEdits;this._applyingInlineOutputEdits=!1,e===t.document&&(i||d.mode===A.automatic||d.mode===A.snapsOnly?(this._processDocumentContentChange(d,t.document,t.contentChanges,!0),i&&d.mode===A.onsave&&!this._liveShareClientActive()&&t.document.save()):d.mode===A.once?this._stop(d):(this._resetStatusBar(),this._clearDecorations(d),this._processDocumentContentChange(d,t.document,t.contentChanges,!1)))})),u.add(k.onDidSaveTextDocument(t=>{e===t&&d.mode===A.onsave&&this._processDocumentContentChange(d,t,[],!0)})),u.add(S.onDidChangeActiveTextEditor(i=>{const s=d.editors.includes(i);d.editors=d.editors.filter(e=>S.visibleTextEditors.includes(e)),S.visibleTextEditors.filter(t=>t.document===e).forEach(e=>{d.editors.includes(e)||(d.editors.push(e),this._updateDocuments(d,d.documentUpdates),this._highlightActiveTraceStepIfRequired(d,t,{reveal:!d.traceExplorer.isCodeStoryViewer(t)}))}),s&&this._updateDocuments(d,d.documentUpdates),d.editors.length?d.traceExplorer.isActiveCodeStoryViewer(i)&&(this._updateCodeStoryIfRequired(d,i),this._highlightActiveTraceStepIfRequired(d,i,{})):d.traceExplorer.closeCodeStory(!0)})),u.add(S.onDidChangeTextEditorSelection(t=>{if(t&&t.selections&&t.selections.length&&(t.textEditor.document===e||d.traceExplorer.isCodeStoryViewer(t.textEditor))){const e=t.selections[0];if(d.activeLineNumber!==e.active.line){d.activeLineNumber=e.active.line,d.activeLineNumberCapturedInCodeStoryViewer=d.traceExplorer.isCodeStoryViewer(t.textEditor);const i=d.activeLineNumber;this._setInlineValuesLineContext(d.messages&&d.messages[i]&&d.messages[i].removable)}(this._pro&&d.showValueOnSelection&&(d.mode===A.automatic||d.mode===A.snapsOnly)||d.traceExplorer.traceBeingNavigated())&&(this._showValueOnMultilineSelection&&(e.start.line!==e.end.line||e.start.line===e.end.line&&e.start.character!==e.end.character)||e.start.line===e.end.line&&e.start.character!==e.end.character||e.start.line===e.end.line-1&&0===e.end.character)&&this._showValue("show")}}));const p=c.bind(this._absoluteFilePath,this);d.output=new v(this.outputChannel,b,d.fileName,p,this._state.coreClient.dmp,d.disposable,this._outputDocumentSelector,!!this._projectRoot(),this._liveShareClientActive(),d.id,this._compactMessageOutput,()=>d.traceExplorer.traceBeingNavigated(),()=>d.traceExplorer.traceBeingAutoPlayed(),()=>d.hasAnyEnabledBreakpointsInActiveEditor,()=>this._pro,()=>r.workspace.getConfiguration().get("quokka.showCodeLensInOutputChannel",!0),()=>d.isCodeStoryEnabled,()=>d.isProfilingEnabled),this._colorizeOutput?d.output.useMarkup():d.output.disableMarkup(),d.traceExplorer=new _(this._context,this,d),this._updateBreakpointsContext(d),l||(d.start({localRoot:this._projectRoot()||d.localRoot,quokkaFolder:this._quokkaFolder,client:"VSCode",cv:r.version,fileName:d.fileName,fileId:d.fileId,editorTypeScript:o.join(process.mainModule.filename,"../../extensions/node_modules/typescript"),snapsOnlyMode:i===A.snapsOnly,snapsAutoRun:i===A.snapsOnly?d.metadata.permissive:void 0}),d.on("notification",e=>this._showNotification(e,d)),d.on("backgroundTaskProgress",e=>{d.tasks&&d.tasks[e.id]&&d.tasks[e.id](e.stage,e.message)}),d.on("busy",()=>{this._sendToLiveShareClients("busy",d),this.processSessionBusy(d)}),d.on("copyToClipboard",e=>{r.env.clipboard.writeText(e.data)}),d.on("stopped",e=>{this._sendToLiveShareClients("stopped",d),this._stop(d),e.deactivate&&(this.stopAll(!0),this._forceDeactivate())}),d.on("started",()=>{this._sendToLiveShareClients("started",d,{mode:d.mode}),this.processStarted(d)}),d.on("stats",e=>{if(this._sendToLiveShareClients("stats",d,e),d.stats=e,delete d.status,delete d.liveConsoleOutput,delete d.allLiveConsoleOutput,d.mode===A.snapsOnly){const e=d.metadata;if(void 0===e.sticky&&(e.sticky=!d.stats.noSnapsFound),d.stats.noSnapsFound){if(e.counters.misses++,!e.sticky&&e.counters.misses>20||e.sticky&&e.counters.misses>100)return e.counters.stops++,void this._stop(d,{initiator:"snaps"})}else e.counters.misses=0,e.counters.stops=0}this.processStats(d),e&&e.messages&&(this._valueExplorer.update(d,e.messages),this._runScheduledActionOnResultsAvailable())}),d.on("live",()=>{d.fileChangedInEditor(d.fileName,d.textDocument.getText(),void 0,void 0,d.fileId,this._getLogpoints(d)),d.fileOpenedInEditor(d.fileName),d.editors.includes(S.activeTextEditor)&&r.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!0)}),d.on("configChanged",e=>{this._changePro(e&&e.pro),r.commands.executeCommand("setContext","quokka.isProfilingEnabled",!!e.profiling),r.commands.executeCommand("setContext","quokka.isCodeStoryEnabled",!!e.codeStory),d.output.setHeaderData(e),d.headerData=e,d.showValueOnSelection=!0===e.showValueOnSelection,d.showSingleInlineValue=!1!==e.showSingleInlineValue,d.autoLog=!0===e.autoLog,d.isProfilingEnabled=!!e.profiling,d.isCodeStoryEnabled=!!e.codeStory,this._setShowValueOnSelectionEnabledContext(d.showValueOnSelection),this._setShowSingleInlineValueEnabledContext(d.showSingleInlineValue),this._setAutoLogEnabledContext(d.autoLog),this._sendToLiveShareClients("configChanged",d,e)}),d.on("documentUpdates",e=>{delete d.documentUpdates,d.traceExplorer.anyVisibleCodeStoryEditors()&&(d.documentUpdates=e),this._updateDocuments(d,e),d.traceExplorer.traceBeingNavigated()&&d.traceExplorer.forEachVisibleCodeStoryEditor(t=>d.traceExplorer.updateTimelineEditorInlineValueDecorations(t,d.activeLineNumber+1,e)),this._sendToLiveShareClients("documentUpdates",d,e)}),d.on("consoleError",e=>{e&&e.split("\n").forEach(e=>e&&this._debugOutputChannel.appendLine(`[Error] #${d.id} ${e}`,"error")),d.emit("stats",e)}),d.on("consoleLog",e=>{e&&e.split("\n").forEach(e=>e&&this._debugOutputChannel.appendLine(`[Info]  #${d.id} ${e}`))}),d.on("consoleOutput",e=>{this._sendToLiveShareClients("consoleOutput",d,e),this._displayLiveConsoleOutput(d,e)}),d.on("navigationRequested",e=>this._navigate(e.file,e.loc)),d.on("profileAvailable",e=>{r.commands.executeCommand("vscode.open",r.Uri.file(e.path),-2)}),d.on("traceNavigated",e=>this._processTraceNavigation(d,e)),d.on("traceNavigationReset",()=>this.stopTraceNavigation()),d.on("testTimelineReset",()=>this.closeCodeStory(d))),d.status="progress",this._updateStatusBarForActiveSession(d),u.add(()=>{if(d.output.dispose(),d.traceExplorer.dispose(),d.tasks)for(const e of Object.keys(d.tasks))d.tasks[e]("completion");d.stop(),this._clearDecorations(d),delete d.editors,delete d.disposable,delete d.output,d===this._activeSession&&delete this._activeSession,I._clearIdleSessionTimeout(d),this._debugOutputChannel.appendLine(`[Info]  #${d.id} Quokka.js stopped`),this.outputChannel.clear(),this.outputChannel.append(b)}),this.emit("started");const g=this._context.workspaceState.get("quokka:runningstate:"+I._hash(d.textDocument.uri.fsPath));this._automaticRestart&&d.mode===A.automatic?this._context.workspaceState.update("quokka:runningstate:"+I._hash(d.textDocument.uri.fsPath),1):g&&this._context.workspaceState.update("quokka:runningstate:"+I._hash(d.textDocument.uri.fsPath),0)}processStats(e){e.stats&&(I._outputResults(e.output,e.stats),this._processErrors(e)),this._updateStatusBarForActiveSession(e),I._sessionIsActive(e)}processStarted(e){r.workspace.getConfiguration().get("quokka.showOutputOnStart",!0)&&e.mode!==A.snapsOnly&&(this._liveShareClientActive()?this._liveShare.outputChannelShown||(this._liveShare.outputChannelShown=!0,this._showOutputChannel()):this._showOutputChannel()),this._liveShareClientActive()&&S.showTextDocument(e.textDocument,e.editors&&(e.editors.length||void 0)&&e.editors[0]&&e.editors[0].viewColumn)}processSessionBusy(e){clearTimeout(this._statusUpdateTimeout),this._statusUpdateTimeout=setTimeout(()=>{e.status="progress",this._updateStatusBarForActiveSession(e)},y),e.liveConsoleOutput=[],e.allLiveConsoleOutput=[],this._scheduleSessionIdleTimeout(e)}_updateBreakpointsContext(e){e.hasAnyEnabledBreakpointsInActiveEditor=!!this._getBreakpoints(e).length,e===this._activeSession&&this._setContext("quokka.hasAnyEnabledBreakpointsInActiveEditor",e.hasAnyEnabledBreakpointsInActiveEditor),this._activeSessions.forEach(e=>e.output.refreshHeaderCommands())}_forceDeactivate(){this._deactivator(),c.each(L,e=>r.commands.registerCommand(`quokka.${e}`,()=>S.showWarningMessage("Please restart VS Code for a new trial session of Quokka.js 'Pro'.")))}_showNotification(e,t){const i=[];if(~e.text.indexOf("expire")&&"warning"===e.type&&this._suppressExpirationNotifications)return;const s=e=>e&&e.url&&r.commands.executeCommand("vscode.open",e.url);if("expiredLicense"===e.id)if(e.invalidVersion){e.text="You are not licensed to use Quokka PRO features for this version of Quokka. As your 12 months of free Quokka updates have expired, this is likely a result of VS Code updating your Quokka extension automatically.",i.push({title:"Renew",url:r.Uri.parse(f.getLicenseDetails().renewUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"}),i.push({title:"Switch to 'Community'",command:"quokka.switchToCommunity"});const t=new Date(e.expiryDate),o="https://quokkajs.com/docs/previous.html?expirydate="+t.getUTCFullYear()+"-"+(t.getUTCMonth()+1)+"-"+t.getUTCDate();i.push({title:"Help / Downgrade",url:r.Uri.parse(o),command:s})}else{e.text="Your Quokka.js 'Pro' license free upgrades period has expired. If you would like to work with the latest version of Quokka.js 'Pro' and future versions released within the next 12 months, please renew your license. If you have already purchased the new license, please activate it.",i.push({title:"Renew",url:r.Uri.parse(f.getLicenseDetails().renewUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"});const t=()=>{r.workspace.getConfiguration().update("quokka.suppressExpirationNotifications",!0,r.ConfigurationTarget.Global)};i.push({title:"Don't show again",command:t})}else e.expiringSoon?e.trial?(e.text="Your Quokka trial period is almost over and finishes on "+e.expirationDateStringFormatted+". If you would like to continue to use Quokka 'PRO', please visit our website to purchase a license.",i.push({title:"Purchase",url:r.Uri.parse(f.getLicenseDetails().purchaseUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"})):(e.text="Your Quokka license free upgrades period expires on "+e.expirationDateStringFormatted+". If you would like to work with the latest version of Quokka and future versions released within the next 12 months, please visit our website to upgrade your license.",i.push({title:"Renew",url:r.Uri.parse(f.getLicenseDetails().renewUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"}),i.push({title:"What's New",command:()=>{f.createOrShow(this._context,{type:"showAllWhatsNew"})}})):e.suggestProEdition?(i.push({title:"Switch to 'Pro'",command:()=>{this._switchEdition(!0,t),f.createOrShow(this._context,{type:"goToLicenseSection"})}}),i.push({title:"More info",url:r.Uri.parse("https://quokkajs.com/pro?referrer=VSCode"),command:s})):e.logPoints?(i.push({title:"More about Logpoints",url:r.Uri.parse("https://quokkajs.com/whatsnew/logpoints.html?referrer=VSCode"),command:s}),i.push({title:"Turn Show Value On Selection back On",command:()=>{const e=this._loadQuokkaConfig();e.showValueOnSelection=!0,this._saveQuokkaConfig(e)}})):(~e.text.indexOf("continue-trial-link")?i.push({title:"Continue Trial",command:()=>t&&!t.isDisposed()&&t.continueTrial()}):~e.text.indexOf("extended-trial-license-link")&&i.push({title:"Request License",command:"_requestTrialLicense"}),~e.text.indexOf("activate-link")&&i.push({title:"Activate",command:"quokka.showLicense"}),~e.text.indexOf("purchase")&&(i.push({title:"Purchase",url:r.Uri.parse("https://quokkajs.com/pro?referrer=VSCode"),command:s}),i.push({title:"Switch to 'Community'",command:"quokka.switchToCommunity"})));e.allowMuting&&i.push({title:"Don't show again",command:()=>t&&!t.isDisposed()&&t.muteNotification(e.id)}),e.text=e.text.replace(/<br\/><br\/>/g," ").replace(/<br\/>/g," ").replace(/<[^>]*>/g,"");const o=[e.text].concat(i);S["show"+e.type.charAt(0).toUpperCase()+e.type.substr(1)+("info"===e.type?"rmation":"")+"Message"].apply(S,o).then(this._executeCommand),0===e.text.indexOf("Can not start node.js process")&&S.showInformationMessage('You may use the "node" setting to configure the location of node.',{title:"More info",url:r.Uri.parse("https://quokkajs.com/docs/configuration.html#nodejs-version")}).then(e=>{e&&e.url&&r.commands.executeCommand("vscode.open",e.url)})}_checkAndSyncSession(e){return!(!S.visibleTextEditors.find(t=>t.document===e.textDocument)||e===this._activeSession)&&(this._activeSession&&(this._activeSession.output.disableChannel(),this._activeSession.traceExplorer.closeCodeStory(!0)),this._activeSession=e,this._liveShareClientActive()||(e.mode===A.snapsOnly?this._setSnapsExecutionAllowed(e.metadata.permissive):this._setSnapsExecutionAllowed(!0)),this._updateBreakpointsContext(e),e.output.enableChannel(),e.output.render(),this.processStats(e),!0)}_requestTrialLicense(){f.createOrShow(this._context,{type:"trial"})}showLicense(){f.createOrShow(this._context,{type:"activate"})}processLicenseChange(e,t){if(c.isUndefined(e))return;let i="";try{i=JSON.parse(Buffer.from(a.readFileSync(this._ol).toString(),"base64").toString())}catch(e){i={}}let s="";try{s=a.readFileSync(this._lkp).toString()}catch(e){}if(/^[a-zA-Z0-9_+&*-]+(?:\.[a-zA-Z0-9_+&*-]+)*@(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,63}$/.test(e)){try{i.quokkaEmail=e.trim(),i.lastUpdate=(new Date).getTime(),a.writeFileSync(this._ol,Buffer.from(JSON.stringify(i)).toString("base64")),this._activeLicenseSession&&(this._activeLicenseSession.stop(),this._activeLicenseSession=null);const s=new this._Session;s.stop=(()=>{s===this._activeLicenseSession&&(this._activeLicenseSession=null)}),s.start({localRoot:this._projectRoot(),quokkaFolder:this._quokkaFolder,client:"VSCode",cv:r.version,fileName:"quokka.js",editorTypeScript:o.join(process.mainModule.filename,"../../extensions/node_modules/typescript"),ol:!0}),s.on("notification",e=>{t({type:"notification",text:e})}),this._activeLicenseSession=s,this.switchToPro()}catch(e){t({type:"error",text:"Unable to save email activation request: "+e.message,items:["Dismiss"]})}return}try{a.unlinkSync(this._ol)}catch(e){}const l=s,d=e||"",u=!!this._parseLicenseKey(l),h=this._parseLicenseKey(d),p=!!h;let _=!1;if(p||!d&&u)try{if(a.writeFileSync(this._lkp,d),h.isBundle){const e=o.join(n.homedir(),".wallaby"),t=o.join(e,"key.lic");a.existsSync(e)||a.mkdirSync(e),a.writeFileSync(t,d)}_=p}catch(e){t({type:"error",text:"Unable to save license key: "+e.message,items:["Dismiss"]}),_=!1}else t({type:"error",text:"The entered license key is not a valid Quokka.js 'Pro' license key.",items:[]});_&&(t({type:"info",text:`Quokka.js 'Pro' is licensed to: ${h.licensee}. Upgrades and updates until: ${h.expiration}.`,items:[]}),this.switchToPro()),this._syncSettings()}_parseLicenseKey(e){if(c.isString(e))try{let t=this._utils.parseKey(e);if(t.licenseeName&&t.expirationDateString&&~t.licensedProduct.indexOf("Quokka"))return{licensee:t.licenseeName,isBundle:0===t.licensedProduct.indexOf("Wallaby.js + Quokka.js"),expiration:t.expirationDateStringFormatted||t.expirationDateString}}catch(e){return}}switchToCommunity(){this._switchEdition(!1,this._activeSession)}switchToPro(){this._switchEdition(!0,this._activeSession)}_treasureHunt(){this._createLanguageFile("JavaScript",`/*_____________________________________________________________________________\n__________  DO YOU HAVE WHAT IT TAKES TO FIND QUOKKA PRO TREASURE?  ___________\n          |                   |                  |                     |\n _________|________________.=""_;=.______________|_____________________|_______\n|                   |  ,-"_,=""     \`"=.|                  |\n|___________________|__"=._o\`"-._        \`"=.______________|___________________\n          |                \`"=._o\`"=._      _\`"=._                     |\n _________|_____________________:=._o "=._."_.-="'"=.__________________|_______\n|                   |    __.--" , ; \`"=._o." ,-"""-._ ".   |\n|___________________|_._"  ,. .\` \` \`\` ,  \`"-._"-._   ". '__|___________________\n          |           |o\`"=._\` , "\` \`; .". ,  "-._"-._; ;              |\n _________|___________| ;\`-.o\`"=._; ." \` '\`."\\\` . "-._ /_______________|_______\n|                   | |o;    \`"-.o\`"=._\`\`  '\` " ,__.--o;   |\n|___________________|_| ;     (#) \`-.o \`"=.\`_.--"_o.-; ;___|___________________\n____/______/______/___|o;._    "      \`".o|o_.--"    ;o;____/______/______/____\n/______/______/______/_"=._o--._        ; | ;        ; ;/______/______/______/_\n____/______/______/______/__"=._o--._   ;o|o;     _._;o;____/______/______/____\n/______/______/______/______/____"=._o._; | ;_.--"o.--"_/______/______/______/_\n____/______/______/______/______/_____"=.o|o_.--""___/______/______/______/____\n/______/______/______/______/______/______/______/______/______/______/______*/\n\n// Welcome to Quokka Pro Treasure Hunt! It only takes a minute to complete,\n// and a very special surprise awaits those who can do it.\n\n// If you get stuck, here's some pointers:\n// Quick Module Install:  https://quokkajs.com/docs/#modules\n// Live Comments:         https://quokkajs.com/docs/#comments\n// Value Explorer:        https://quokkajs.com/docs/#value-explorer\n\n// Good luck and enjoy!\n\n// 1) Fix the error below and install the missing module for the current quokka\n//    file using the link in the Quokka output or in the line hover message\n//    or quick action.\n\n${x}\n\n// 2) So, you have found an old chest, there may be some treasure inside it.\n//    You need to pass a correct string key to the "open" function.\n//    The "open" function returns a clue about how to find the key.\n//    Add Quokka live comment at the end of the line to see the returned value:\n//    chest.open('paste_key_here') //?\n\nchest.open('paste_key_here')\n`,"treasure-hunt")}_switchEdition(e,t){const i=this._loadQuokkaConfig();if(i.pro=e,this._changePro(e),this._saveQuokkaConfig(i),!this._liveShareClientActive()&&t&&!t.isDisposed()){const e=t.textDocument,i=t.editors[0];this.stopAll(!0),t.mode!==A.automatic&&t.mode!==A.snapsOnly&&t.mode!==A.onsave||this._start(e,i,t.mode)}}_processErrors(e){this._liveShareClientActive()||e.stats.errors&&(e.errors={},I._addError(e,I._createLineDataObject(e,e=>e.missingPackage,e=>[{title:`Install "${e.missingPackage}" package for the current quokka file`,command:"installMissingPackageToQuokka"},this._projectRoot()&&{title:`Install "${e.missingPackage}" package into the project`,command:"installMissingPackageToProject"}])),I._addError(e,I._createLineDataObject(e,e=>e.missingBrowserGlobal,e=>[{title:`"${e.missingBrowserGlobal}" looks like a browser global`},{title:"Install and use quokka browser plugin",command:"installQuokkaPlugin",args:["jsdom","jsdom-quokka-plugin"]}])),I._addError(e,I._createLineDataObject(e,e=>e.undefinedName,e=>[{title:`Add "import ${e.undefinedName} from '${e.undefinedName}';"`,command:"addImport",arg:e.undefinedName},{title:`Add "const ${e.undefinedName} = require('${e.undefinedName}');"`,command:"addRequire",arg:e.undefinedName}])))}static _addError(e,t){t&&(e.errors[t.line]=t)}static _createHoverObject(e){return e.filter(e=>!!e).map(e=>e.command?`\n[${e.title}](${encodeURI(`command:quokka.${e.command}${e.arg?"?"+JSON.stringify(e.arg):""}`)})`:e.title).join("\n")}static _createCommands(e){return e.filter(e=>e&&e.command).map(e=>({title:e.title,command:`quokka.${e.command}`,arguments:e.args?e.args:e.arg?[e.arg]:void 0}))}static _createLineDataObject(e,t,i){const s=e.stats.errors.find(t),o=s&&s.stack||[];if(o.length){const t=c.find(o,t=>t.file===e.fileName);if(t&&t.loc&&t.loc.split){const e=i(s);let o=I._createHoverObject(e);return r.MarkdownString&&((o=new r.MarkdownString(o)).isTrusted=!0),{line:parseInt(t.loc.split(":")[0],10)-1,hover:{value:o},commands:I._createCommands(e)}}}}static _checkConfigurationSettings(){try{let e=r.workspace.getConfiguration();if(e){e.get("quokka.suppressGlyphMarginNotifications",!1)||e.get("editor.glyphMargin",!0)||S.showWarningMessage("Quokka.js will not display coverage indicators in the gutter because the `editor.glyphMargin` setting is set to `false`. You can hide this message by setting `quokka.suppressGlyphMarginNotifications` to `false`.")}}catch(e){}}_updateConfigurationFromSettings(){let e="",t=!1;try{var i=this._loadQuokkaConfig();e=i.node,i.useWsl&&(t=i.useWsl)}catch(e){}try{process.env.WALLABY_USE_WSL=t;const i=r.workspace.getConfiguration();if(i){this._suppressExpirationNotifications=i.get("quokka.suppressExpirationNotifications",!1),this._colorizeOutput=i.get("quokka.colorizeOutput",!0),this._compactMessageOutput=i.get("quokka.compactMessageOutput",!1);const t=i.get("quokka.node",e);t?process.env.WALLABY_NODE=t:delete process.env.WALLABY_NODE}}catch(e){}}activate(){let e;this._checkSnapMarkers=c.debounce(c.bind(this._upgradeBackgroundSession,this),1e3),this._onceDocumentStopsChanging=c.debounce(c.bind(this._onceDocumentStopsChanging,this),100),this._onceDocumentStopsChangingWithDelay=c.debounce(c.bind(this._onceDocumentStopsChanging,this),1e3),I._outputResults=c.debounce(c.bind(I._outputResults,this),100),this._executeCommand=c.bind(this._execute,this),this._disposables.add(()=>{var e;if(null===(e=this._statusBarItem)||void 0===e||e.dispose(),this._activeLicenseSession)try{this._activeLicenseSession.stop(),this._activeLicenseSession=null}catch(e){}this._activeSessions.forEach(e=>e.disposable.dispose()),this._activeSessions.length=0,r.commands.executeCommand("setContext","quokka.hasActiveSession",!1)});const t=()=>{try{const i=this._context.globalState.get("quokka:runRecentFile");i&&g.pathToMetadataKey(i.projectRoot)===g.pathToMetadataKey(this._projectRoot())&&(this._context.globalState.update("quokka:runRecentFile",void 0),this.runRecentFile(i))}finally{e=setTimeout(t,1e3)}};t(),this._disposables.add(()=>{clearTimeout(e)})}_projectRoot(e){if(e&&this._multiFolderWorkspaces&&k.workspaceFolders&&k.workspaceFolders.length){const t=c.find(k.workspaceFolders,t=>~e.indexOf(t.uri.fsPath+o.sep));if(t)return this._currectProjectRoot=t.uri.fsPath,this._currectProjectRoot}if(this._currectProjectRoot)if(this._multiFolderWorkspaces&&k.workspaceFolders){const e=c.find(k.workspaceFolders,e=>this._currectProjectRoot===e.uri.fsPath);if(e)return e.uri.fsPath}else if(k.rootPath&&this._currectProjectRoot===k.rootPath)return k.rootPath;return this._multiFolderWorkspaces&&k.workspaceFolders?k.workspaceFolders.length?k.workspaceFolders[0].uri.fsPath:void 0:k.rootPath||""}selectWorkspaceFolder(){this._multiFolderWorkspaces&&k.workspaceFolders&&k.workspaceFolders.length>1&&S.showWorkspaceFolderPick&&S.showWorkspaceFolderPick().then(e=>{e&&(this._currectProjectRoot=e.uri.fsPath)})}deactivate(){this._disposables.dispose()}static _sessionIsActive(e){I._clearIdleSessionTimeout(e)}_sessionIsIdle(e){this._clearDecorations(e),delete e.stats,e.liveConsoleOutput&&!e.liveConsoleOutput.started&&e.output.clearAndRenderHeader()}static _clearIdleSessionTimeout(e){e.idleTimeout&&(clearTimeout(e.idleTimeout),delete e.idleTimeout)}_clearDecorations(e){e.editors.forEach(e=>{c.each(this._coverageDecorationTypes,t=>e.setDecorations(t,[]))})}_scheduleSessionIdleTimeout(e){I._clearIdleSessionTimeout(e),e.idleTimeout=setTimeout(()=>this._sessionIsIdle(e),w)}_displayLiveConsoleOutput(e,t){if(!e.liveConsoleOutput)return;const i=e.liveConsoleOutput.started;e.liveConsoleOutput=e.liveConsoleOutput.concat(t),e.liveConsoleOutput.started=i,e.liveConsoleOutput.started?e.displayLiveConsoleOutputTimeout||this._displayPendingLiveConsoleOutput(e):(e.liveConsoleOutput.started=!0,e.displayLiveConsoleOutputTimeout=setTimeout(()=>{delete e.displayLiveConsoleOutputTimeout,e.liveConsoleOutput&&e.liveConsoleOutput.length&&(e.output.clearAndRenderHeader(),this._displayPendingLiveConsoleOutput(e))},150))}_displayPendingLiveConsoleOutput(e){e.allLiveConsoleOutput=e.allLiveConsoleOutput.concat(e.liveConsoleOutput),e.liveConsoleOutput.forEach(t=>e.output.appendConsoleMessage(t)),e.liveConsoleOutput.length=0}_execute(e){if(e&&e.command)return"function"==typeof e.command?e.command(e):~e.command.indexOf("quokka.")?r.commands.executeCommand(e.command):this[e.command]()}_processDocumentContentChange(e,t,i,s){e.isDisposed()||t&&t.uri&&t.uri.scheme&&"file"!==t.uri.scheme&&"untitled"!==t.uri.scheme&&"vsls"!==t.uri.scheme||(i.length&&(e.changeTs=Date.now()),e.changes=e.changes.concat(i),s&&(!this._liveShareClientActive()&&e.mode===A.snapsOnly&&e.metadata.counters.misses>3?this._onceDocumentStopsChangingWithDelay(e,t):this._onceDocumentStopsChanging(e,t)))}_onceDocumentStopsChanging(e,t){if(e.isDisposed()||!e.changes.length||t.isClosed)return;if(this._liveShareClientActive())return;clearTimeout(this._statusUpdateTimeout);const i=t.getText();if(e.mode===A.snapsOnly&&e.snaps){if(e.metadata.permissive)if(1===e.changes.length&&"``"===e.changes[0].text){const t=e.changes[0],i=t.range.start.line+1,s=t.range.start.character,o=e.snaps.lines[t.range.start.line];o&&o.body.range[2]===i&&o.body.range[3]===s?e.preservedCursorPosition={line:t.range.start.line,character:t.range.start.character+1}:delete e.preservedCursorPosition}else delete e.preservedCursorPosition;else{const t=t=>{const i=t.range.start.line+1,s=t.range.start.character+1,o=e.snaps.lines[t.range.start.line];o&&(o.body.range[0]<i&&o.body.range[2]>i||o.body.range[0]===i&&o.body.range[2]!==i&&o.body.range[1]+2<s||o.body.range[0]===i&&o.body.range[2]===i&&o.body.range[1]+2<s&&o.body.range[3]>=s||o.body.range[2]===i&&o.body.range[0]!==i&&o.body.range[3]>=s)&&(this._liveShareServerActive()?S.showInformationMessage("Please use the code action or the command to active the snap."):(e.allowToRunSnaps(),e.metadata.permissive=!0,this._setSnapsExecutionAllowed(!0)))};if(1===e.changes.length&&0===e.changes[0].rangeLength&&" "===e.changes[0].text){const i=e.changes[0];e.metadata.trigger&&e.snaps?(Date.now()-e.metadata.trigger.timestamp<1e3&&e.metadata.trigger.offset+1===i.rangeOffset&&t(i),delete e.metadata.trigger):e.metadata.trigger={offset:e.changes[0].rangeOffset,timestamp:Date.now()}}else 2===e.changes.length&&0===e.changes[0].rangeLength&&0===e.changes[1].rangeLength&&e.changes[0].rangeOffset+1===e.changes[1].rangeOffset&&" "===e.changes[0].text&&" "===e.changes[1].text?(t(e.changes[1]),delete e.metadata.trigger):delete e.metadata.trigger}if(e.metadata.counters.misses>5&&!this._doChangesHaveSnapMarkersTraces(t,e.changes)&&!this._doesTextContainSnapMarkers(i))return void(e.changes=[])}this._statusUpdateTimeout=setTimeout(()=>{e.status="progress",this._updateStatusBarForActiveSession(e)},y),e.fileChangedInEditor(e.fileName,i,{start:c.chain(e.changes).map(e=>e.range.start.line).min().value()+1,end:c.chain(e.changes).map(e=>e.range.end.line).max().value()+1},!1,e.fileId,this._getLogpoints(e)),e.content=i,e.changes=[]}_resetStatusBar(){this._statusBarItem.command="quokka.selectAction",this._statusBarItem.text=`$(debug-disconnect)${N}`,this._statusBarItem.tooltip=this._makeStatusBarTooltip("reset")}_updateStatusBarForBackgroundSession(e){this._statusBarItem.command="quokka.selectAction";let t="$(eye)";switch(e){case"paused":t="$(eye-closed)";break;case"disabled":t="$(debug-disconnect)";break;default:t="$(eye)"}this._statusBarItem.text=`${t}${N}`,this._statusBarItem.tooltip=this._makeStatusBarTooltip(e)}_updateStatusBarForActiveSession(e,t=!0){if(!e.isDisposed()){if(clearTimeout(this._statusUpdateTimeout),e.metadata&&!e.metadata.permissive||e.stats&&e.stats.noSnapsFound){this._statusBarItem.text=`$(zap)${N}`,this._statusBarItem.command="quokka.selectAction";const t=e.metadata&&!e.metadata.permissive?"blocked":"empty";this._statusBarItem.tooltip=this._makeStatusBarTooltip(t)}else{this._statusBarItem.command=e.mode!==A.snapsOnly?"quokka.showOutput":"quokka.selectAction";let t,i=e.status;i||(i=c.isString(e.stats)?"failing":e.stats?e.stats.errors.length?"failing":"passing":"failing",t=e.mode!==A.snapsOnly&&e.stats&&e.stats.time),i&&(this._statusBarItem.text="progress"===i?`$(sync~spin)${N}`:`${"failing"===i?"$(warning)":"$(check-all)"}${N}${t?` ${t}ms`:""}`),this._statusBarItem.tooltip=this._makeStatusBarTooltip("running")}t&&this._checkAndSyncSession(e)}}_updateDocuments(e,t){if(e.isDisposed())return;if(e.changes.length&&!this._liveShareClientActive()){let t=!0;if(1===e.changes.length){const i=e.changes[0];if(1===i.text.length&&F.has(i.text)){const i=e.textDocument.getText();e.content&&e.content.length===i.length&&e.content===i&&(t=!1)}}if(t)return}e.documentUpdates=t,e.updateTs=Date.now();const i=S.activeTextEditor&&S.activeTextEditor.selection;let s=void 0,o=!1;i&&i.active&&(s=i.active.line);const a=e.preservedCursorPosition;delete e.preservedCursorPosition;const n=new Set;c.each(S.visibleTextEditors,l=>{if(!l)return;const d=l.document;if(d!==e.textDocument)return;e.hasRemovableMessages=!1,e.messages=Object.create(null);const u=t[e.fileName];if(!u)return;const h={1:[],2:[],3:[],4:[],5:[],6:[],7:[],8:[],9:[],10:[],systemLog:[]};if(c.each(u.lines||[],t=>{const i=t.num-1;if(i<0||i>=d.lineCount)return;const a=d.lineAt(i);if(!a)return;const n=t.meta||{},l={range:new r.Range(a.lineNumber,a.firstNonWhitespaceCharacterIndex,a.lineNumber,a.range.end.character)},c=t.err||t.log,u=t.longLog||c,p=n.log&&n.log.system;if(u&&!p&&(l.hoverMessage=r.MarkdownString?new r.MarkdownString("```\n"+u+"\n```"):{value:u}),h[p?"systemLog":t.state+(t.meta&&t.meta.system?5:0)].push(l),c&&(l.renderOptions={after:{contentText:c}},t.log)){const t=n.log&&n.log.removable;e.messages[a.lineNumber]={removable:t},t&&(e.hasRemovableMessages=!0,a.lineNumber===s&&(o=!0))}}),(u.snaps||u.lines)&&c.each(h,(e,t)=>l.setDecorations(this._coverageDecorationTypes[t],e)),u.snaps&&u.snaps.length){e.snaps={lines:{},raw:u.snaps};for(const t of u.snaps){const i=t.body.range[0]-1,s=t.body.range[2]-1;for(let o=i;o<=s;o++)e.snaps.lines[o]=t;if(t.output&&t.output.range){const i=t.output.range[0]-1,s=t.output.range[2]-1;for(let o=i;o<=s;o++)e.snaps.lines[o]=t}}}else delete e.snaps;if(u.snaps&&u.snaps.length&&!u.noCodeChange&&!n.has(d)&&!this._liveShareClientActive()){let e=!1;const t=new r.WorkspaceEdit;for(const i of u.snaps){const s=this._validateSnapOutputRange(d,i);s&&(t.replace(d.uri,s,i.output.content),e=!0)}if(e){this._applyingInlineOutputEdits=!0;const e=a&&i&&i.active&&i.active.line===a.line&&i.active.character===a.character;r.workspace.applyEdit(t).then(()=>{e&&(S.activeTextEditor.selection=i)})}}n.add(d)}),S.activeTextEditor&&e.textDocument===S.activeTextEditor.document&&(this._setInlineValuesLineContext(o),this._setInlineValuesFileContext(e.hasRemovableMessages))}_navigate(e,t,{reveal:i=!0,select:s=!0,focus:o=!0}={reveal:!0,select:!0,focus:!0}){if(!e)return;if(this._activeSession&&e===this._activeSession.fileName)return this.goToLineInQuokkaFile(t,{reveal:i,select:s,focus:o});let a,n,l=this._absoluteFilePath(e);return c.isNumber(t)?a=t:c.isArray(t)?(a=t[0],n=t[1]):c.isString(t)&&(t=t.split(":"),a=t[0]&&parseInt(t[0],10),n=t[1]&&parseInt(t[1],10)),c.isNumber(a)?a-=1:a=0,c.isNumber(n)||(n=0),k.openTextDocument(l).then(e=>S.showTextDocument(e,{preserveFocus:!o})).then(e=>{if(!i)return e;if(!n){const t=e.document&&e.document.lineAt(a);t&&(n=t.firstNonWhitespaceCharacterIndex)}let t=new r.Position(a,n);return e.revealRange(new r.Range(t,t),2),s?(e.selection=new r.Selection(t,t),e):e})}_processTraceNavigation(e,t,i=!0,s=!1){t&&t.restart&&(i=!1),c.each(S.visibleTextEditors,t=>e.traceExplorer.destroyStackTraceDecorations(t));const{decorationType:o,step:a}=e.traceExplorer.traceNavigated(t);if(this._updateStatusBarForActiveSession(e),o)return this._navigateWithTraceHighlight(e,a,o,{onlyHighlightRangeInVisibleEditors:i,preserveTimelineSelection:s,requestTimelineIfStepIsOutOfSight:!0})}_highlightActiveTraceStepIfRequired(e,t,{reveal:i=!1,onlyHighlightRangeInVisibleEditors:s=!0}){if(t&&e.traceExplorer.traceBeingNavigated()){const o=e.traceExplorer.lastActiveStep();o&&t.document&&this._navigateWithTraceHighlight(e,o,e.traceExplorer.activeTraceFrameDecorationType(),{reveal:i,onlyHighlightRangeInVisibleEditors:s})}}stopTraceNavigation(){const e=this._activeSession;e&&(e.traceExplorer.stopTraceNavigation(),e.traceExplorer.closeCodeStory(!0),this._updateStatusBarForActiveSession(e))}viewCallStack(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&e.traceExplorer.requestCallStack()}hideCallStack(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&(e.traceExplorer.hideCallStack(),e.stats&&e.stats.trace&&(delete e.stats.trace.callStack,this.processStats(e)))}openCallStackFrame(e){const t=this._activeSession;t&&t.traceExplorer.traceBeingNavigated()&&(c.each(S.visibleTextEditors,e=>t.traceExplorer.destroyStackTraceDecorations(e)),this._navigateWithTraceHighlight(t,e,t.traceExplorer.activeTraceCallStackFrameDecorationType(),{requestTimelineIfStepIsOutOfSight:!0}),t.traceExplorer.updateTraceContextCallStackFrame(e))}revealTraceStep(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&e.editors.forEach(t=>{this._highlightActiveTraceStepIfRequired(e,t,{reveal:!0,onlyHighlightRangeInVisibleEditors:!1})})}viewCodeStory(e={},t){return s(this,void 0,void 0,function*(){if(t=t||this._activeSession){if(!t.traceExplorer.traceBeingNavigated())return this._openCodeStoryOnTraceNavigationStarted(t,e),void this.debug();yield t.traceExplorer.viewCodeStory(e),t.traceExplorer.forEachVisibleCodeStoryEditor(e=>{this._highlightActiveTraceStepIfRequired(t,e,{reveal:!0,onlyHighlightRangeInVisibleEditors:!0})})}})}_openCodeStoryOnTraceNavigationStarted(e,t){const i=e.traceExplorer.onTraceNavigationStarted(()=>{i.dispose(),this.viewCodeStory(t,e)})}closeCodeStory(e){e.traceExplorer.closeCodeStory()}_updateCodeStoryIfRequired(e,t){if(e.traceExplorer.isActiveCodeStoryViewer(t)&&!e.traceExplorer.updateCodeStoryIfLoaded(t)&&e.traceExplorer.traceBeingNavigated()){const t=e.traceExplorer.lastActiveStep();this.viewCodeStory({before:t&&t.frame})}}autoPlayCode(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&(e.traceExplorer.autoPlayCode(),this._activeSessions.forEach(e=>e.output.refreshHeaderCommands()))}pauseCodeExecution(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&(e.traceExplorer.pauseCodeExecution(),this._activeSessions.forEach(e=>e.output.refreshHeaderCommands()))}_navigateWithTraceHighlight(e,t,i,{onlyHighlightRangeInVisibleEditors:s=!1,reveal:o=!0,requestTimelineIfStepIsOutOfSight:a=!1,preserveTimelineSelection:n=!1}){const l=(e,s)=>{const o=t.range[0]!==t.range[2],a=s>=0?s:t.range[0]-1,n=e.document&&e.document.lineAt(a),l=t.range[1],c=!l&&n?n.firstNonWhitespaceCharacterIndex:l;o?e.setDecorations(i,[new r.Range(a,c,a,1e4)]):e.setDecorations(i,[new r.Range(a,c,a,t.range[3])])};if(e.traceExplorer.anyVisibleCodeStoryEditors()){const i=e.traceExplorer.getCodeStoryLineByStep(t.frame);if(i>=0?(o&&e.traceExplorer.forEachVisibleCodeStoryEditor(s=>{let o=new r.Position(i,t.range[1]);s.revealRange(new r.Range(o,o),2),n||(s.selection=new r.Selection(o,o)),e.traceExplorer.updateTimelineEditorInlineValueDecorations(s,i+1,e.documentUpdates)}),e.traceExplorer.forEachVisibleCodeStoryEditor(e=>l(e,i))):(e.traceExplorer.forEachVisibleCodeStoryEditor(t=>e.traceExplorer.destroyStackTraceDecorations(t)),a&&this.viewCodeStory({before:t.frame,reveal:!0})),e.traceExplorer.isCodeStoryViewer(S.activeTextEditor))return this._navigate(t.file,t.loc,{reveal:o&&!s,select:!1,focus:!1}).then(l)}return this._navigate(t.file,t.loc,{reveal:o&&!s,select:!s}).then(l)}_absoluteFilePath(e){const t=this._activeSession&&this._activeSession.localRoot;return o.resolve(this._projectRoot()||t,e)}_setInlineValuesLineContext(e){e=!!e,this._previousInlineValuesLineContext!==e&&(this._previousInlineValuesLineContext=e,this._setContext("quokka.lineHasRemovableInlineValues",e))}_setInlineValuesFileContext(e){e=!!e,this._previousInlineValuesFileContext!==e&&(this._previousInlineValuesFileContext=e,this._setContext("quokka.fileHasRemovableInlineValues",e))}_setShowSingleInlineValueEnabledContext(e){this._setContext("quokka.showSingleInlineValueEnabled",e)}_setShowValueOnSelectionEnabledContext(e){this._setContext("quokka.showValueOnSelectionEnabled",e)}_setAutoLogEnabledContext(e){this._setContext("quokka.autoLogEnabled",e)}_setSnapsExecutionAllowed(e){this._setContext("quokka.snapsExecutionAllowed",e)}_setContext(e,t){r.commands.executeCommand("setContext",e,t)}selectAction(){var e;return s(this,void 0,void 0,function*(){const t=[];if(this._liveShareClientActive()||!r.window.tabGroups.all.flatMap(e=>e.tabs).length)return void this.openStartView();const i=S.activeTextEditor,s=this._activeSession;if(!i||P.has(i.document.languageId)||"file"!==i.document.uri.scheme&&"untitled"!==i.document.uri.scheme){if(s&&i&&s.textDocument===i.document&&s.mode===A.snapsOnly&&s.metadata&&!s.metadata.permissive&&t.push({label:"$(zap)  Allow snap(s) execution until file is closed",action:()=>this.allowFileSnapsExecution()}),i&&(!s||s.textDocument!==i.document)&&r.workspace.getConfiguration().get("quokka.snapsAutoDiscovery",!0)){const e=this._backgroundSessions.find(e=>e.document===i.document);let s=this._filesWithSnapsDiscoveryPaused.has(i.document.uri.toString());s||(s=e&&(e.paused||e.hibernated)),s||(s=this._isDocumentNotEligibleForSnapDiscovery(i.document)&&!e),s?t.push({label:"$(eye)  Resume snaps discovery in current file",action:()=>this.startFileSnapsDiscovery()}):"file"!==i.document.uri.scheme&&"untitled"!==i.document.uri.scheme||t.push({label:"$(eye-closed)  Pause snaps discovery in current file",action:()=>this.stopFileSnapsDiscovery()})}s&&i&&s.textDocument===i.document&&s.mode===A.snapsOnly&&(this.outputChannel&&t.push({label:"$(json)  Show output pane",action:()=>this._showOutputChannel()}),t.push({label:"$(stop-circle)  Stop",action:()=>this.stopCurrent()})),(t.length||i&&"file"!==i.document.uri.scheme&&"untitled"!==i.document.uri.scheme)&&t.push({label:"$(home)  Open start view",action:()=>this.openStartView()}),0===t.length?this.openStartView():null===(e=yield r.window.showQuickPick(t,{placeHolder:"Select an action",title:"Quokka.js"}))||void 0===e||e.action()}else this.openStartView()})}allowFileSnapsExecution(){var e;if(this._liveShareClientActive())return;const t=this._activeSession;t&&t.mode===A.snapsOnly&&(null!==(e=t.metadata)&&void 0!==e&&e.permissive||(t.metadata.permissive=!0,this._setSnapsExecutionAllowed(!0),t.allowToRunSnaps({run:!0})))}insertSnapOutput(e){const t=S.activeTextEditor;if(!t)return;if(this._liveShareClientActive())return;const i=this._activeSession;if(!i)return;if(i.changeTs&&i.changeTs>i.updateTs)return;if(!i.snaps||i.metadata&&!i.metadata.permissive)return;const s=t.selection;if(!s&&!e)return;const o=i.snaps.lines[e||s.start.line];if(o&&!o.output){const e=new r.Position(o.body.range[2]-1,o.body.range[3]);I._addCode(t,e,"``")}}deleteSnapOutput(e){const t=S.activeTextEditor;if(!t)return;const i=t.document;if(!i)return;if(this._liveShareClientActive())return;const s=this._activeSession;if(!s)return;if(s.changeTs&&s.changeTs>s.updateTs)return;if(!s.snaps||s.metadata&&!s.metadata.permissive)return;const o=t.selection;if(!o&&!e)return;const a=s.snaps.lines[e||o.start.line];if(a&&a.output){const e=this._validateSnapOutputRange(i,a);if(e){const t=new r.WorkspaceEdit;t.delete(i.uri,e),r.workspace.applyEdit(t)}}}stopFileSnapsDiscovery(){const e=S.activeTextEditor;if(!e)return;const t=e.document;if(!t)return;"file"!==t.uri.scheme&&"untitled"!==t.uri.scheme||this._filesWithSnapsDiscoveryPaused.add(t.uri.toString());const i=this._backgroundSessions.find(e=>e.document===t);i&&(i.changes=[],i.paused=!0,this._updateStatusBarForBackgroundSession("paused"))}startFileSnapsDiscovery(){const e=S.activeTextEditor;if(!e)return;const t=e.document;t&&("file"!==t.uri.scheme&&"untitled"!==t.uri.scheme||(this._filesWithSnapsDiscoveryPaused.delete(t.uri.toString()),this._registerBackgroundSession(e,{resume:!0})))}_registerBackgroundSession(e,t){var i,s;if(!e)return;const o=e.document;if(o&&!this._liveShareClientActive())if(!P.has(o.languageId)||"file"!==o.uri.scheme&&"untitled"!==o.uri.scheme)"file"!==o.uri.scheme&&"untitled"!==o.uri.scheme&&r.window.tabGroups.all.flatMap(e=>e.tabs).length||this._resetStatusBar();else{if(this._activeSessions.find(e=>e.textDocument===o))return;if(!r.workspace.getConfiguration().get("quokka.snapsAutoDiscovery",!0))return void this._updateStatusBarForBackgroundSession("disabled");const a=o.uri.toString();if(this._filesWithSnapsDiscoveryPaused.has(a))return void this._updateStatusBarForBackgroundSession("paused");if(this._filesWithSnapsDiscoveryDisabled.has(a))return void this._updateStatusBarForBackgroundSession("disabled");if(!(null===t||void 0===t?void 0:t.resume)&&this._isDocumentNotEligibleForSnapDiscovery(o))return void this._updateStatusBarForBackgroundSession("paused");const n=this._backgroundSessions.find(e=>e.document===o);if(n)return void((null===t||void 0===t?void 0:t.resume)?(this._backgroundSessions=this._backgroundSessions.filter(e=>e!==n),n.disposable.dispose(),this._registerBackgroundSession(e)):n.hibernated?this._updateStatusBarForBackgroundSession("paused"):this._updateStatusBarForBackgroundSession(n.paused?"paused":"watching"));const l={disposable:new m,document:o,changes:[],hibernated:null===t||void 0===t?void 0:t.hibernated,fresh:!(null===(i=null===t||void 0===t?void 0:t.counters)||void 0===i?void 0:i.stops)||(null===t||void 0===t?void 0:t.resume),metadata:{sticky:null===t||void 0===t?void 0:t.sticky,permissive:!1,counters:{stops:(null===(s=null===t||void 0===t?void 0:t.counters)||void 0===s?void 0:s.stops)||0,misses:0}}};if(this._backgroundSessions.push(l),!(null===t||void 0===t?void 0:t.recovered)&&!l.hibernated&&(l.fresh=!0,this._upgradeBackgroundSession(l)))return;if(l.metadata.counters.stops<=3&&!l.hibernated){this._updateStatusBarForBackgroundSession("watching");const e=o.languageId;l.disposable.add(k.onDidChangeTextDocument(t=>{o===t.document&&(t.document.languageId!==e?(this._backgroundSessions=this._backgroundSessions.filter(e=>e!==l),l.disposable.dispose()):o.isClosed||l.paused||t.contentChanges.length>0&&(l.changes=l.changes.concat(t.contentChanges),this._upgradeBackgroundSession(l)))}))}else this._updateStatusBarForBackgroundSession("paused");l.disposable.add(k.onDidCloseTextDocument(e=>{o===e&&(this._backgroundSessions=this._backgroundSessions.filter(e=>e!==l),l.disposable.dispose(),this._resetStatusBar())}))}}_upgradeBackgroundSession(e){const t=e.document,i=e.changes,s=e.fresh;e.changes=[],e.fresh=!1;let o=!1;if(s){const i=t.getText();if(i.length>512e3||i.length>51200&&t.lineCount<100)return this._filesWithSnapsDiscoveryDisabled.add(t.uri.toString()),e.paused=!0,this._updateStatusBarForBackgroundSession("disabled"),!1;o=this._doesTextContainSnapMarkers(i)}else this._doChangesHaveSnapMarkersTraces(t,i)&&(o=this._doesTextContainSnapMarkers(t.getText()));if(o){const i=S.visibleTextEditors.find(e=>e.document===t);if(i)return e.metadata.permissive=!r.workspace.getConfiguration().get(s?"quokka.snapsAutoRunConfirmOnOpen":"quokka.snapsAutoRunConfirmOnEdit",!0),this._start(t,i,A.snapsOnly,void 0,!0),!0}return!1}_isDocumentNotEligibleForSnapDiscovery(e){const t=e.uri.toString();return!!(t.includes("node_modules")||t.includes(".cache")||t.includes(".next")||t.includes(".svelte-kit")||t.includes(".angular")||t.includes(".nuxt"))}_doChangesHaveSnapMarkersTraces(e,t){let i=0,s=0,o=!1;const a=[],n=new Set,l=e.lineCount;if(t.length>10)return!0;for(const r of t){const t=r.range.start.line,c=r.range.end.line,d=r.text;if(d.length>0){if(d.length>20)return!0;if(d.length>4&&(T.lastIndex=0,T.exec(d)))return!0;let e=!1;(d.startsWith("\n")||d.startsWith("\r"))&&(e=!0);for(let t=0;t<d.length&&(123===d.charCodeAt(t)&&(i++,e=!0),125===d.charCodeAt(t)&&(s++,e=!0),!(o=i>=2||s>=2));t++);if(o)break;e&&a.push(r)}else{let i=l>t?e.lineAt(t):void 0;if(i&&i.isEmptyOrWhitespace){o=!0;break}if(n.has(t)||n.add(t),t!==c&&l>c){if((i=e.lineAt(c))&&i.isEmptyOrWhitespace){o=!0;break}n.has(c)||n.add(c)}}}if(!o&&n.size>0)for(const t of n.values()){const i=l>t?e.lineAt(t):void 0;if(i){const e=i.text;if(e.indexOf("{{")>=0){o=!0;break}if(e.indexOf("}}")>=0){o=!0;break}}}if(!o&&a.length>0)for(const t of a){let i=t.range.start.line-3,s=t.range.end.line+3;i=i<0?0:i,s=s>e.lineCount?e.lineCount:s;const a=e.getText(new r.Range(new r.Position(i,0),new r.Position(s,0)));if(T.lastIndex=0,o=!!T.exec(a))break}return o}_doesTextContainSnapMarkers(e){return D.lastIndex=0,!!D.exec(e)&&(E.lastIndex=D.lastIndex+1,!!E.exec(e))}_validateSnapOutputRange(e,t){if(t&&t.output){const i=t.output;if(i&&i.range){const t=i.range[0]-1,s=i.range[1],o=i.range[2]-1,a=i.range[3],n=new r.Range(t,s,o,a),l="`",c=e.getText(new r.Range(t,s,t,s+1)),d=e.getText(new r.Range(o,a-1,o,a));if(c===l&&d===l){if(t===o&&a-s<2)return;return n}}}}_makeHoverIcon(e,t,i,s){return s=s||{},`<a href='${r.Uri.parse(`command:${e}?`+encodeURIComponent(JSON.stringify(s)))}' title='${t}'><span class='codicon codicon-${i}'></span></a>`}_makeStatusBarTooltip(e){this._statusBarTooltip||(this._statusBarTooltip={pro:{},community:{}});const t=this._pro?this._statusBarTooltip.pro:this._statusBarTooltip.community;if(t[e])return t[e];{let i="Quokka.js can't be started for the current file. Try to open a javascript or a typescript file.";switch(e){case"blocked":i="Quokka.js has found snaps in the current file. Press Spacebar twice inside <code>{{...}}</code> to activate snaps for the current file.";break;case"empty":i="Quokka.js is running but can't find any snaps. Add <code>{{ ⏎ }}</code> anywhere in your code to create a snap.";break;case"watching":i="Quokka.js snaps discovery is active. Add <code>{{ ⏎ }}</code> anywhere in your code to create a snap.";break;case"disabled":i="Quokka.js snaps discovery is disabled. Enable the <code>Snaps Auto Discovery</code> setting and restart VS Code to activate automatic snaps discovery.";break;case"paused":i="Quokka.js snaps discovery is paused for the current file. You may resume it by running the <code>Start Snaps Discovery in Current File</code> command.";break;case"running":i="Quokka.js is running for the current file."}const s=new r.MarkdownString(`<table width='100%'>\n  <tr>\n    <td width='50%'>\n      <h4>Quokka.js ${this._pro?'<span style="color:var(--vscode-editorLightBulb-foreground);">PRO</span>':"Community"}</h4>\n    </td>\n    <td width='50%' align='right'>\n      <a href='command:quokka.openStartView' title='Open Start View'><span class='codicon codicon-home'></span></a><span>&nbsp;&nbsp;</span><a href='https://quokkajs.com/docs' title='Open Docs'><span class='codicon codicon-book'></span></a><span>&nbsp;&nbsp;</span><a href='https://github.com/wallabyjs/quokka/issues' title='Report Bug or Request Feature'><span class='codicon codicon-feedback'></span></a>\n    </td>\n  </tr>\n</table>\n<table width='100%'>\n  <tr>\n    <td>\n      ${i}<br/>\n    </td>\n  </tr>\n</table>\n`);return s.supportHtml=!0,s.isTrusted=!0,t[e]=s,s}}static _outputResults(e,t,i){let s,o=e.lines();e.build(t);let a=e.lines();if(!(s=i||a.length!==o.length))for(let t=0,i=a.length;t<i;t++)if(e.areDifferent(a[t],o[t])){s=!0;break}s&&e.render()}showLogs(){return s(this,void 0,void 0,function*(){const e=this._projectRoot()||this._activeSession&&this._activeSession.localRoot;if(e){const t=o.join(n.homedir(),".quokka","logs",o.basename(e),"trace.log");try{const e=yield k.openTextDocument(t);yield S.showTextDocument(e,{preserveFocus:!0,viewColumn:r.ViewColumn.Beside})}catch(e){S.showErrorMessage("Error showing logs"+e.message)}}})}}t.exports=I},{"./InteractiveExamples":3,"./SalesEvent":4,"./checkOffers":5,"./compositeDisposable":6,"./outputBuilder":9,"./recentFilesExplorer":10,"./startViewPanel":11,"./traceExplorer":12,"./valueExplorer":13,crypto:void 0,fs:void 0,http:void 0,os:void 0,path:void 0,querystring:void 0,"sql.js":void 0,uuid:void 0,vscode:void 0,vsls:void 0}],8:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.LicenseReader=void 0;const s=e("fs"),o=e("os"),a=e("path");class n{static getLicenseDetails(e){let t;try{t=s.statSync(n.startPage).mtimeMs}catch(e){t=(new Date).getTime()}const i={state:"demoLicense",productType:"",registeredTo:"",expiryDate:"",email:"",daysUntilExpiry:"",isBundle:!1,upgradeUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",purchaseUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",renewUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",previousVersionUrl:"https://quokkajs.com/docs/previous.html",newInstall:!1,installTime:t};try{JSON.parse(s.readFileSync(n.quokkaConfigPath).toString()).pro||(i.state="community")}catch(e){i.newInstall=!0,i.state="community"}if("community"===i.state)return i;try{const e=JSON.parse(Buffer.from(s.readFileSync(n.olp).toString(),"base64").toString());i.email=e.quokkaEmail||"",i.registeredTo=i.email,i.onlineLicense=!!e.quokkaEmail,i.state="activating"}catch(e){}try{const t=s.readFileSync(n.lkp).toString().split(":").reduce((e,t)=>t.trim());if(t.length<50){if(!i.onlineLicense)try{parseInt(t,10)+1314e6<+new Date&&(i.state="trialDemoOver")}catch(e){i.state="trialDemoOver"}}else{const s=Buffer.from(t,"base64").toString().split("\n"),[o,a,,,r,l]=s[1].split(",");i.registeredTo=s[0],i.email=i.email||o,i.isBundle=!!~a.indexOf("Wallaby.js");const c=!!~a.toLowerCase().indexOf("company")||!!~a.toLowerCase().indexOf("enterprise"),d="wallabyjs@gmail.com"===o||"1"===l;i.isBundle?i.productType="Wallaby.js + Quokka.js":i.productType="Quokka.js";const[u,h,p]=s[2].split("/").map(e=>parseInt(e,10));i.expiryDate=u+" "+n.monthNames[h-1]+", "+p;let _=!1;const g=new Date(Date.UTC(p,h-1,u)),m=new Date,v=Math.floor((g.getTime()-m.getTime())/864e5);i.daysUntilExpiry=`${v} day${1===v?"":"s"}`,v<0?d?i.state="trialDemoOver":(e.setHours(0,0,0,0),g.setHours(0,0,0,0),g<e?(i.previousVersionUrl="https://quokkajs.com/docs/previous.html?expirydate="+g.getUTCFullYear()+"-"+(g.getUTCMonth()+1)+"-"+g.getUTCDate(),i.state="expiredWrongVersion",i.key=t,_=!0):(i.state="expired",i.key=t,_=!0)):v<=14?d?i.state="trialLicense":(i.state="expiring",i.key=t,_=!0):d?i.state="trialLicense":(i.state="activated",i.key=t,_=!0),_&&!c&&(c?(i.purchaseUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka",r?(i.upgradeUrl=`https://wallabyjs.com/store/personal/?renewalOrder=${r}&upgrade=1&referrer=qsp`,i.renewUrl=`https://wallabyjs.com/store/personal/?renewalOrder=${r}&referrer=qsp`):(i.upgradeUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka",i.renewUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka")):(i.upgradeUrl=`https://wallabyjs.com/store/personal/?renewalEmail=${encodeURIComponent(o)}&upgrade=1&referrer=qsp`,i.renewUrl=`https://wallabyjs.com/store/personal/?renewalEmail=${encodeURIComponent(o)}&referrer=qsp`))}}catch(e){}return i}}i.LicenseReader=n,n.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],n.quokkaFolder=a.join(o.homedir(),".quokka"),n.wallabyFolder=a.join(o.homedir(),".wallaby"),n.lkp=a.join(n.quokkaFolder,".qlc"),n.quokkaConfigPath=a.join(n.quokkaFolder,"config.json"),n.olp=a.join(n.wallabyFolder,".ol"),n.startPage=a.join(n.quokkaFolder,"startPage.json")},{fs:void 0,os:void 0,path:void 0}],9:[function(e,t,i){"use strict";const s=e("vscode"),o=global._,a={none:"",link:Array(2).join("​"),empty:Array(6).join("​"),error:{start:"",end:" "},context:Array(4).join("​"),header:Array(5).join("​"),string:{start:"",end:" "},diff:Array(7).join("​"),diffIns:Array(2).join("⁠"),diffDel:Array(2).join("‍"),tmpDiffIns:{start:"wsDiffIns",end:"weDiffIns"},tmpDiffDel:{start:"wsDiffDel",end:"weDiffDel"}};t.exports=class{constructor(e,t,i,a,n,r,l,c,d,u,h,p,_,g,m,v,f,k){const S=this;this._prefix=t,this._lines=[],this._codeLens=[],this._links=[],this._quokkaFileName=i,this._displayedFileName=u,this._contentLimit=1048576,this._channel=e,this._absolutePathResolver=a,this._dmp=n,this._hasOpenedProject=c,this.render=o.debounce(o.bind(this.render,this),300),this._header="Quokka",this.isLiveShareClient=d,this.disposed=!1,this.channelEnabled=!0,this._messageSeparator=h?"":"\n",this._isProVersion=m,this._isCodeStoryEnabled=f,this._isProfilingEnabled=k,this._hasAnyEnabledBreakpointsInActiveEditor=g,this._isTraceBeingNavigated=p,this._isTraceBeingAutoPlayed=_,this._getShowCodeLensInOutputChannelSetting=v,this._onDidChangeCodeLenses=new s.EventEmitter,this._replaceApiAvailable=!0,this.useMarkup(),r.add(s.languages.registerDocumentLinkProvider(l,{provideDocumentLinks:e=>{if(!S.channelEnabled||S.disposed)return[];const t=e.lineAt(0);return t&&t.text&&~t.text.indexOf(this._header)?this._links:[]}}));let y=s.languages.registerCodeLensProvider(["quokka-output"],{onDidChangeCodeLenses:this._onDidChangeCodeLenses.event,provideCodeLenses:e=>(y&&S.disposed&&(y.dispose(),y=null),!S.channelEnabled||S.disposed?[]:S._activeCodeLens||[])})}enableChannel(){this.channelEnabled=!0,this._refreshCodeLens()}disableChannel(){this.channelEnabled=!1,this._refreshCodeLens(!0)}useMarkup(){this._markupTokens=o.extend({},a)}disableMarkup(){this._markupTokens.none=this._markupTokens.link=this._markupTokens.empty=this._markupTokens.error=this._markupTokens.context=this._markupTokens.header=this._markupTokens.string=this._markupTokens.diff=""}dispose(){this.clear(),this.disposed=!0}build(e){if(this._lines=[],this._links=[],this._codeLens=[],delete this._callStackDisplayed,this._appendLine("none",0,this._header),o.isString(e))this._appendLine("error",0,e);else if(o.isObject(e)){if(this._isTraceBeingNavigated()&&e.trace){const t=Math.floor((e.trace.currentFrame+1)/e.trace.length*100);if(this._traceNavigationProgress!==t&&(this._traceNavigationProgress=t,this._refreshCodeLens()),e.trace.callStack){const t=e.trace.callStack[e.trace.currentFrame];t&&t.stack&&(this._outputCallStack(t.stack),this._callStackDisplayed=!0)}}o.each(e.errors,e=>this._outputError(e)),o.each(e.messages,e=>this._outputMessage(e))}}_headerCodeLens(){const e=[];return this._isTraceBeingNavigated()?(e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:`Execution progress: ${o.pad(this._traceNavigationProgress,3,"ㅤ")}%ㅤ`,tooltip:"Reveal Active Frame",command:"quokka.revealTraceStep"})),this._isTraceBeingAutoPlayed()?e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-pause) Pause Code Execution",tooltip:"Pause Code Execution",command:"quokka.pauseCodeExecution"})):(e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-reverse-continue)ㅤ",tooltip:"Run Back to Active Line",command:"quokka.playTraceBackwardToSelection"})),this._hasAnyEnabledBreakpointsInActiveEditor()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(circle-filled)ㅤ",tooltip:"Run Back to Breakpoint",command:"quokka.playTraceBackwardToBreakpoint"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-out)ㅤ",tooltip:"Step Back Out",command:"quokka.playTracePrevStepOut"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-into)ㅤ",tooltip:"Step Back Into",command:"quokka.playTracePrevStep"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-back)ㅤ",tooltip:"Step Back Over",command:"quokka.playTracePrevStepOver"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-restart)ㅤ",tooltip:"Restart Time Machine From The First Executed Line",command:"quokka.debug",arguments:[{fromTheStart:!0}]})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-stop)ㅤ",tooltip:"Stop Time Machine",command:"quokka.stopTraceNavigation"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-alt)ㅤ",tooltip:"Auto Play Code",command:"quokka.autoPlayCode"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-over)ㅤ",tooltip:"Step Over",command:"quokka.playTraceNextStepOver"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-into)ㅤ",tooltip:"Step Into",command:"quokka.playTraceNextStep"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-out)ㅤ",tooltip:"Step Out",command:"quokka.playTraceNextStepOut"})),this._hasAnyEnabledBreakpointsInActiveEditor()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(circle-filled)ㅤ",tooltip:"Run to Breakpoint",command:"quokka.playTraceForwardToBreakpoint"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-continue)ㅤ",tooltip:"Run to Active Line",command:"quokka.playTraceForwardToSelection"})),this._callStackDisplayed||e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(list-selection)ㅤ",tooltip:"View Current Call Stack",command:"quokka.viewCallStack"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(organization)ㅤ",tooltip:"Share Current Quokka on codeclip.io",command:"quokka.share"})),this._isProVersion()&&this._isCodeStoryEnabled()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-line-by-line) View Code Story",tooltip:"View Code Story",command:"quokka.viewCodeStory"})))):(this._quokkaFileName.endsWith(".svelte")||this._quokkaFileName.endsWith(".vue")||(e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"$(debug-alt)ㅤ",tooltip:"Start Time Machine With Auto Play",command:"quokka.debugAutoPlay"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug)ㅤ",tooltip:"Start Time Machine",command:"quokka.debug"})),this._isProVersion()&&this._isCodeStoryEnabled()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-line-by-line)ㅤ",tooltip:"View Code Story",command:"quokka.viewCodeStory"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(organization)ㅤ",tooltip:"Share Current Quokka on codeclip.io",command:"quokka.share"}))),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(files)ㅤ",tooltip:"View Recent Quokka Files",command:"quokka.viewRecentFiles"})),this._isProVersion()&&(this._isProfilingEnabled()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(watch)ㅤ",tooltip:"View CPU Profile",command:"quokka.profile"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(settings)ㅤ",tooltip:"Edit Current Quokka Session Settings",command:"quokka.editSessionSettings"}))),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(stop-circle)ㅤ",tooltip:"Stop",command:"quokka.stopCurrent"}))),e}lines(){return this._lines}render(){this._doRender()}refreshHeaderCommands(){this._refreshCodeLens()}_doRender(e){if(this.disposed||!this.channelEnabled)return;let t="";(e=e||0)||(t+=this._prefix);for(let i=e,s=this._lines.length;i<s;i++)if((t+=this._lines[i]+"\n").length>this._contentLimit){t+="\n--- output truncated to "+this._contentLimit+" bytes ---\n";break}if(e)this._channel.append(t.replace(/\u0000/g,""));else if(this._channel.replace&&this._replaceApiAvailable)try{this._channel.replace(t.replace(/\u0000/g,""))}catch(e){this._channel.clear(),this._channel.append(t.replace(/\u0000/g,"")),this._replaceApiAvailable=!1}else this._channel.clear(),this._channel.append(t.replace(/\u0000/g,""));this._refreshCodeLens()}_refreshCodeLens(e){this.isLiveShareClient||(this._activeCodeLens=[],!e&&this._lines.length&&this._getShowCodeLensInOutputChannelSetting()&&(this._activeCodeLens=this._headerCodeLens().concat(this._codeLens.slice())),this._onDidChangeCodeLenses.fire())}clear(){this._lines=[],this._links=[],this._codeLens=[],this._activeCodeLens=[],this._onDidChangeCodeLenses.fire()}clearAndRenderHeader(){this.clear(),this._appendLine("none",0,this._header),this._doRender()}appendConsoleMessage(e){const t=this._lines.length;this._outputMessage(e),this._doRender(t)}show(){this.disposed||this._channel.show(!0)}areDifferent(e,t){return e!==t}setHeaderData(e){if(this.disposed)return;let t=e.plugins||[];e.builtInPlugins&&t.push(...e.builtInPlugins),t.sort((e,t)=>e.localeCompare(t));try{this._header=this._markupStartToken("header")+"Quokka"+(this._isProVersion()?" PRO":"")+(e.snapsOnlyMode?" {⚡}":"")+" '"+this._displayedFileName+"'"+` (node: ${e.nodeVersion}${e.ts?`, TypeScript: ${e.ts.version&&"v"+e.ts.version||"unknown version"}`:""}${e.babel?`, babel: ${e.babel.version&&"v"+e.babel.version||"unknown version"}`:""}${t.length?`, plugins: ${t.join(", ")}`:""})${this._markupStartToken("header")}`}catch(e){console.log(e)}}_markupStartToken(e){const t=this._markupTokens[e];return o.isObject(t)?t.start:t}_markupEndToken(e){const t=this._markupTokens[e];return o.isObject(t)?t.end:t}_markupAltEndToken(e){const t=this._markupTokens[e];return o.isObject(t)?t.altEnd||t.end:t}_outputMessage(e){if("diff"===e.type){if(!e.context&&!e.actual&&!e.expected)return;e.text=e.context,delete e.context}e.context&&e.context.replace&&(e.context=e.context.replace(/\r\n\s*/g," ").replace(/\n\s*/g," "));const t=e.text&&(e.text.length>20||~e.text.indexOf("\n"))&&"diff"!==e.type;let i="error"===e.type?"error":"warn"===e.type||"diff"===e.type?"context":"none";if(t)this._addRevealInValueExplorerLens(this._lines.length+1,e),this._appendLine("none"===i&&e.format?"string":i,0,this._messageSeparator+e.text),this._outputLink(e,1);else{"diff"===e.type&&this._outputDiff(0,e.expected,e.actual),e.format&&(i="string");let t="string"==typeof e.text?`${"diff"===e.type?o.pad("",2,"   "):this._messageSeparator}${this._markupStartToken(i)}${e.text||"[empty string]"}${this._markupAltEndToken(i)}`:"";if(e.file){"string"!==i&&(t+=" ");const s=this._markupStartToken("link")+e.file+this._displayLocation(e.loc)+this._markupEndToken("link");t+=this._buildStackEntryLineText(e.context)+s,this._addFileLink(e.file,e.loc,s,t.length-s.length,this._lines.length+(t.split(/\r\n|\r|\n/).length-1)),this._addRevealInValueExplorerLens(this._lines.length+1,e)}this._appendLine("none",0,t)}}_addRevealInValueExplorerLens(e,t){this._codeLens.push(new s.CodeLens(new s.Range(e,0,e,1),{title:"$(list-tree) Reveal in value explorer",tooltip:"Reveal in value explorer",command:"quokka.revealInValueExplorer",arguments:[t]}))}_outputCallStack(e){this._appendLine("none",0,""),this._codeLens.push(new s.CodeLens(new s.Range(this._lines.length,0,this._lines.length,1),{title:"$(eye-closed) Hide Call Stack",tooltip:"Hide Call Stack",command:"quokka.hideCallStack"}));for(let t of e){const e=this._buildStackEntryLineText(t.context),i=e+this._markupStartToken("link")+t.file+this._displayLocation(t.loc)+this._markupEndToken("link");this._appendLine("none",0,i);let o=this._lines.length-1;this._links.push({range:new s.Range(o,e.length,o,i.length),target:s.Uri.parse("command:quokka.openCallStackFrame?"+encodeURIComponent(JSON.stringify(t)))})}}_outputError({message:e,stack:t,expected:i,actual:s,missingPackage:a,missingBrowserGlobal:n}){let r=this;this._outputDiff(0,i,s),a&&!this.isLiveShareClient&&(this._addEmptyLine(),this._addCustomLinkLine(`Install "${a}" package for the current quokka file`,"command:quokka.installMissingPackageToQuokka",0),this._hasOpenedProject&&this._addCustomLinkLine(`Install "${a}" package into the project`,"command:quokka.installMissingPackageToProject",0)),n&&!this.isLiveShareClient&&(this._addEmptyLine(),this._appendLine("context",0,`"${n}" looks like a browser global`),this._addCustomLinkLine("Install and use quokka browser plugin",`command:quokka.installQuokkaPlugin?${encodeURIComponent(JSON.stringify(["jsdom","jsdom-quokka-plugin"]))}`,0),this._addCustomLinkLine("Open quokka browser plugin documentation","https://quokkajs.com/docs/configuration.html#jsdom",0)),this._appendLine("error",0,this._messageSeparator+e),o.each(t,e=>r._outputLink(e,1))}_outputDiff(e,t,i){if(this._dmp&&(t||i)){this._appendLine("none",0,"");let s=this._dmp.diff_prettyHtml(this._dmp.diff_wordMode(t||"",i||"")).replace(/&para;<br>/g,"\n").replace(/<br>/g,"\n").replace(/<\/?span[^>]*>/g,"").replace(/<ins[^>]*>/g,this._markupStartToken("tmpDiffIns")).replace(/<del[^>]*>/g,this._markupStartToken("tmpDiffDel")).replace(/<\/ins[^>]*>/g,this._markupEndToken("tmpDiffIns")).replace(/<\/del[^>]*>/g,this._markupEndToken("tmpDiffDel")).replace(/style="background:#e6ffe6;"/g,"").replace(/style="background:#ffe6e6;"/g,"").replace(/&lt;/g,"<").replace(/&amp;/g,"&").replace(/&gt;/g,">"),o=0,a=0;this._appendLine("diff",e,s,void 0,void 0,e=>{if(!e)return e;o>0&&(e=this._markupStartToken("diffIns")+e),a>0&&(e=this._markupStartToken("diffDel")+e);let t=(e.match(new RegExp(this._markupStartToken("tmpDiffIns"),"g"))||[]).length,i=(e.match(new RegExp(this._markupEndToken("tmpDiffIns"),"g"))||[]).length;o+=t-i;let s=(e.match(new RegExp(this._markupStartToken("tmpDiffDel"),"g"))||[]).length,n=(e.match(new RegExp(this._markupEndToken("tmpDiffDel"),"g"))||[]).length;return a+=s-n,o>0&&(e+=this._markupEndToken("diffIns")),a>0&&(e+=this._markupEndToken("diffDel")),e.replace(new RegExp(this._markupStartToken("tmpDiffIns"),"g"),this._markupStartToken("diffIns")).replace(new RegExp(this._markupEndToken("tmpDiffIns"),"g"),this._markupEndToken("diffIns")).replace(new RegExp(this._markupStartToken("tmpDiffDel"),"g"),this._markupStartToken("diffDel")).replace(new RegExp(this._markupEndToken("tmpDiffDel"),"g"),this._markupEndToken("diffDel"))})}}_outputLink(e,t){if(e.file){const i=e.file+this._displayLocation(e.loc);this._appendLine("link",t,i,void 0,e.context,(t,s)=>{this._addFileLink(e.file,e.loc,i,s)})}}_addCustomLinkLine(e,t,i){let o=this._lines.length;this._appendLine("none",i,this._markupStartToken("link")+e+this._markupEndToken("link")),this._links.push({range:new s.Range(o,this._markupStartToken("link").length,o,e.length+this._markupEndToken("link").length),target:s.Uri.parse(t)})}_addFileLink(e,t,i,o,a){"."!==e[0]&&e!==this._quokkaFileName||(a=a||this._lines.length,this._links.push({range:new s.Range(a,o,a,o+i.length),target:0===e.indexOf("quokka")?s.Uri.parse("command:quokka.goToLineInQuokkaFile?"+JSON.stringify(this._location(t).substring(1))):s.Uri.parse(s.Uri.file(this._absolutePathResolver(e)).toString()+this._location(t,0))}))}_location(e){let[t,i]=this._locationArray(e);return"#"+(o.isNumber(i)?`${t},${i}`:t)}_locationArray(e){let t,i;return o.isNumber(e)?t=e:o.isArray(e)?(t=e[0],i=e[1]):o.isString(e)&&(t=(e=e.split(":"))[0]&&parseInt(e[0],10),i=e[1]&&parseInt(e[1],10)),o.isNumber(i)&&i<0&&(i=0),[t,i]}_displayLocation(e){if(!e)return"";let[t,i]=this._locationArray(e);return`:${t}${o.isNumber(i)?":"+(i+1):""}`}_addEmptyLine(){this._appendLine("none",0,"")}_appendLine(e,t,i,s,a,n){let r=this,l=i.split("\n"),c=[this._markupStartToken(e)||"",this._markupEndToken(e)||""];o.each(l,(i,d)=>{const u=(s?`[${s}] `:"")+o.pad("",2*t,"   ")+("link"===e?this._buildStackEntryLineText(a):"")+("diff"===e?0===d?c[0]:"":c[0]);let h=u+i+("diff"===e?"":c[1]);if(n){let e=n(h,u.length);e&&(h=e)}"diff"===e&&(h+=d===l.length-1?c[1]:""),r._lines.push(h)})}_buildStackEntryLineText(e){return this._markupStartToken("empty")+"at "+this._markupEndToken("empty")+(e?this._markupStartToken("context")+e+this._markupEndToken("context")+" ":"")}}},{vscode:void 0}],10:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function r(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,r)}l((s=s.apply(e,t||[])).next())})};const o=e("vscode"),a=e("path"),n=e("util"),r=e("fs"),l=e("os"),c=n.promisify(r.readFile),d=n.promisify(r.writeFile),u=e=>c(e).then(e=>e.toString()),h=e=>u(e).catch(()=>""),p=e("./compositeDisposable"),_="quokka-recent",g=o.Uri.parse("quokka-recent:Recent Quokka Files");class m{constructor(e){this._disposables=new p,this._onDidChange=new o.EventEmitter,this._quokkaFolder=e,this._quokkaRecentFilesMetadataPath=a.join(e,"recentFiles.json"),this._quokkaRecentFilesFolderPath=a.join(e,"recentFiles"),this._disposables.add(o.languages.registerCodeLensProvider([_],this)),this._disposables.add(o.workspace.registerTextDocumentContentProvider(_,this)),this.reset()}findRecentScratchFileIdByContent(e){return s(this,void 0,void 0,function*(){if(!e)return;e=e.trim();const t=yield this._getMetadata();if(!t||!t.projects)return;const i=Object.keys(t.projects);let s=0;for(;i.length;){const o=t.projects[i.pop()];if(o){const t=Object.values(o);for(let i of t)if(i.scratchFile){if((i.content&&i.content.trim())===e)return i.fileId;if(++s>=5)return}}}})}reset(){delete this._metadata}dispose(){this._disposed||(this._disposables.dispose(),this._disposed=!0)}show(e){return s(this,void 0,void 0,function*(){if(this.reset(),this._content=yield this._buildContent(e||this._quokkaFolder),!this._content)return;this._onDidChange.fire(g);const t=yield o.window.showTextDocument(g);t.options.lineNumbers=o.TextEditorLineNumbersStyle.Off,o.languages.setTextDocumentLanguage(t.document,_)})}get onDidChange(){return this._onDidChange.event}static prepareContentText(e){return e.replace(/ /g," ")}static formatProjectDir(e){let t=l.homedir();return t.endsWith(a.sep)||(t+=a.sep),e.replace(t,"~")}static pathToMetadataKey(e){return e&&"win32"===process.platform?e.toLowerCase():e}removeRecentFiles(e){return s(this,void 0,void 0,function*(){let t;try{t=JSON.parse(yield u(this._quokkaRecentFilesMetadataPath))}catch(e){}if(!t||!t.projects)return;const i=Object.keys(t.projects);for(;i.length;){const s=i.pop(),o=t.projects[s];if(o)for(let t of e)m.pathToMetadataKey(t.projectRoot)===s&&delete o[t.id]}try{yield d(this._quokkaRecentFilesMetadataPath,JSON.stringify(t))}catch(e){}})}_buildContent(e){return s(this,void 0,void 0,function*(){const t=yield this._getMetadata();if(!t||!t.projects)return;this._lenses=[];const i=m.pathToMetadataKey(e);let s=[];const n=e=>{const t=`${e.modificationDate.toLocaleDateString()} ${e.modificationDate.toLocaleTimeString()}`;let a,n;i===e.projectRootKey||m.pathToMetadataKey(this._quokkaFolder)===e.projectRootKey?a=e.path:(a=e.resolvedPath,n=!0),s.push({text:`⁠${m.formatProjectDir(a)}⁠  ${t} `});const r=(()=>s.length-1)();if(this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Run",tooltip:"Run",command:"quokka.runRecentFile",arguments:[e]})),e.scratchFile&&this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Clone and Run",tooltip:"Clone and Run",command:"quokka.runRecentFile",arguments:[Object.assign({clone:!0},e)]})),n){const t=m.formatProjectDir(e.projectRoot);this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Run in "+t,tooltip:"Run in "+t,command:"quokka.runRecentFile",arguments:[Object.assign({runInParentProject:!0},e)]})),e.scratchFile&&this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Clone and Run in "+t,tooltip:"Clone and Run in "+t,command:"quokka.runRecentFile",arguments:[Object.assign({clone:!0,runInParentProject:!0},e)]}))}this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Remove from recent files",tooltip:"Remove from recent files",command:"quokka.removeRecentFiles",arguments:[{files:[e],reloadRecentFilesView:!0}]})),s.push({text:"​"})},r=t.projects[i];r&&(delete t.projects[i],t.projects[i]=r);const l=Object.keys(t.projects),c=[];for(;l.length;){const e=l.pop(),i=t.projects[e];if(i){const t=Object.values(i).reverse();for(let i of t){i.scratchFile&&(i.path=i.path.replace("quokka","scratch")),i.projectRootKey=e,i.resolvedPath=a.resolve(i.projectRoot,i.path),i.id=i.fileId||m.pathToMetadataKey(i.path);const t=i.content||(yield h(i.scratchFile?a.join(this._quokkaRecentFilesFolderPath,i.fileId):i.resolvedPath));if(!t){c.push(i);continue}i.content=t.trim(),i.modificationDate=new Date(i.ts),n(i);const o=i.content.split(/\r\n|\r|\n/).map(e=>({text:`  ${e}`}));(s=s.concat(o)).push({text:"​"})}}}return c.length&&o.commands.executeCommand("quokka.removeRecentFile",{files:c}),{lines:s,text:s.map(e=>e.text).join("\n"),annotationDecorations:[]}})}provideTextDocumentContent(){return this._content&&this._content.text||""}provideCodeLenses(e){return this._lenses||[]}_getMetadata(){return s(this,void 0,void 0,function*(){if(this._metadata)return this._metadata;try{this._metadata=JSON.parse(yield u(this._quokkaRecentFilesMetadataPath))}catch(e){this._metadata={projects:{}}}return this._metadata})}}t.exports=m},{"./compositeDisposable":6,fs:void 0,os:void 0,path:void 0,util:void 0,vscode:void 0}],11:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function r(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,r)}l((s=s.apply(e,t||[])).next())})};const o=e("vscode"),a=e("util"),n=e("path"),r=e("fs"),l=e("os"),c=e("./licenseReader").LicenseReader;class d{constructor(e,t){this._disposables=[],this._checkOffersResults=void 0,this._panel=e,this._context=t,this._extensionUri=t.extensionUri,this._pendingMessages=[],this._initialized=!1,this._panel.iconPath=o.Uri.file(t.asAbsolutePath("media/logo.svg")),this._load()}static setController(e){d.controller=e}static getStartViewWhatsNewVersion(e){return s(this,void 0,void 0,function*(){const t=o.Uri.joinPath(e.extensionUri,"media","index.html"),i=[...new a.TextDecoder("utf8").decode(yield o.workspace.fs.readFile(t)).matchAll(/data-whats-new-version=["|']([a-zA-Z0-9\-\!\,]+)["|']/gm)],s=e.globalState.get("quokka.country","US");return Math.max(...i.map(e=>{const[,t]=e,[i,o]=t.split("-");return{version:parseInt(i,10),country:o||s}}).filter(e=>e.country===s).map(e=>e.version))})}static showWhatsNewIfRequired(e){return s(this,void 0,void 0,function*(){if(!o.workspace.getConfiguration().get("quokka.showStartViewOnFeatureRelease",!0))return!1;try{if((yield d.getStartViewWhatsNewVersion(e))>d._getUserWhatsNewVersion())return d.createOrShow(e,{type:"whatsnew"}),!0}catch(e){console.log(e)}return!1})}static createOrShow(e,t){const i=o.window.activeTextEditor?o.window.activeTextEditor.viewColumn:void 0;if(d.currentPanel)return d.currentPanel._panel.reveal(i),void d.currentPanel._processAction(e,t);const s=o.window.createWebviewPanel(d.viewType,"Quokka",i||o.ViewColumn.One,{enableScripts:!0,localResourceRoots:[o.Uri.joinPath(e.extensionUri)]});d.currentPanel=new d(s,e),d.currentPanel._processAction(e,t)}_processAction(e,t){return s(this,void 0,void 0,function*(){if(t)switch(t.type){case"activate":d.currentPanel.activateLicense(t);break;case"trial":d.currentPanel.requestTrial(t);break;case"goToLicenseSection":d.currentPanel.goToLicenseSection(t);break;case"showAllWhatsNew":d.currentPanel.showWhatsNew(!0),d.currentPanel._panel.title="Quokka: What's New";break;case"whatsnew":d.currentPanel.showWhatsNew(!1),d.currentPanel._panel.title="Quokka: What's New";break;case"firstInstall":const i=yield d.getStartViewWhatsNewVersion(e);d.controller&&d.controller._salesEvent&&d.controller._salesEvent.setLastUrlOpenedTime(),d._saveUserWhatsNewVersion(i),d.currentPanel.firstInstall(t)}})}static revive(e,t){d.currentPanel&&d.currentPanel.dispose(),d.currentPanel=new d(e,t)}activateLicense(){this._pendingMessages.push({command:"activateLicense"}),this.processPendingMessages()}firstInstall(e){this._pendingMessages.push(Object.assign({command:"firstInstall"},e)),this.processPendingMessages()}goToLicenseSection(){this._pendingMessages.push({command:"goToLicenseSection"}),this.processPendingMessages()}requestTrial(){this._pendingMessages.push({command:"requestTrial"}),this.processPendingMessages()}showWhatsNew(e){const t=e?0:d._getUserWhatsNewVersion();this._pendingMessages.push({command:"showWhatsNew",previousWhatsNewVersion:t}),this.processPendingMessages()}processPendingMessages(){if(this._initialized){const e=this._pendingMessages;this._pendingMessages=[],e.forEach(e=>{this._panel.webview.postMessage(e)})}}_getGlobalConfigSettings(){try{return Object.assign(Object.assign({},d.globalDefaults),JSON.parse(r.readFileSync(d.quokkaConfigPath)))}catch(e){return Object.assign({},d.globalDefaults)}}_saveGlobalConfigSettings(e){e=Object.assign({},e),Object.keys(d.globalDefaults).forEach(t=>{e[t]===d.globalDefaults[t]&&delete e[t]}),r.writeFileSync(d.quokkaConfigPath,JSON.stringify(e)),this._panel.webview.postMessage({command:"globalConfig",globalConfig:this._getGlobalConfigSettings()})}_load(){this._update().then(()=>{this._panel.onDidDispose(()=>this.dispose(),null,this._disposables),this._panel.onDidChangeViewState(()=>{this._panel.visible?this._update():this._initialized=!1},null,this._disposables);const e=e=>{const t=o.workspace.getConfiguration().inspect(e);return void 0!==t.globalValue?t.globalValue:t.defaultValue};this._panel.webview.onDidReceiveMessage(t=>{switch(t.command){case"requestInitialState":const i=e("quokka.compactMessageOutput"),s=e("quokka.showOutputOnStart"),a=e("quokka.startViewStatusBar"),n=e("quokka.suppressExpirationNotifications"),l=e("quokka.showStartViewOnFeatureRelease"),c=e("quokka.automaticRestart"),u=e("quokka.automaticStartRegex"),h=this._context.globalState.get("quokka.country","US"),p=d.controller&&d.controller._buildDate||new Date;return p.setHours(0,0,0),this._panel.webview.postMessage({command:"initialState",settings:{compactMessageOutput:i,showOutputOnStart:s,startViewStatusBar:a,suppressExpirationNotifications:n,showStartViewOnFeatureRelease:l,automaticRestart:c,automaticStartRegex:u},globalConfig:this._getGlobalConfigSettings(),licenseDetails:d.getLicenseDetails(),whatsNewVersion:d._getUserWhatsNewVersion(),buildDate:p,country:h}),this._initialized=!0,void this.processPendingMessages();case"saveGlobalConfig":this._saveGlobalConfigSettings(t.globalConfig);break;case"updateSetting":o.workspace.getConfiguration().update("quokka."+t.setting,t.value,o.ConfigurationTarget.Global);break;case"otherSettings":o.commands.executeCommand("workbench.action.openSettings","quokka");break;case"configJson":r.existsSync(d.quokkaConfigPath)||r.writeFileSync(d.quokkaConfigPath,JSON.stringify({})),o.workspace.openTextDocument(d.quokkaConfigPath).then(e=>o.window.showTextDocument(e));break;case"useCommunityEdition":this._useCommunityEdition();break;case"switchToPro":this._usePro();break;case"launchDemo":this._launchDemo();case"trialRequest":this._requestTrialLicense(t.email);break;case"activateLicense":this._activateLicense(t);break;case"updateWhatsNewVersion":d._saveUserWhatsNewVersion(t.version);break;case"log":console.log(t)}},null,this._disposables)})}_launchDemo(){return s(this,void 0,void 0,function*(){if(d.controller){const e=o.Uri.joinPath(this._extensionUri,"media","interactive-demo.js");let t=new a.TextDecoder("utf8").decode(yield o.workspace.fs.readFile(e));"darwin"===process.platform&&(t=t.replace(/`Ctrl/gm,"`⌘")),d.controller._createLanguageFile("JavaScript",t,"interactive-demo")}})}_useCommunityEdition(){try{let e;try{e=JSON.parse(r.readFileSync(d.quokkaConfigPath))}catch(t){e={}}e.pro=!1,r.writeFileSync(d.quokkaConfigPath,JSON.stringify(e))}catch(e){}this._panel.webview.postMessage({command:"switchToCommunityEdition",licenseDetails:d.getLicenseDetails()})}_usePro(){try{let e;try{e=JSON.parse(r.readFileSync(d.quokkaConfigPath))}catch(t){e={}}e.pro=!0,r.writeFileSync(d.quokkaConfigPath,JSON.stringify(e))}catch(e){}this._panel.webview.postMessage({command:"switchToPro",licenseDetails:d.getLicenseDetails()})}_activateLicense({email:e,key:t}){if(!d.controller)return void this._panel.webview.postMessage({command:"activationError",message:"VS Code has not finished loading, please try and activate again later."});const i=new Date;let s=!1;d.controller.processLicenseChange(e||t,e=>{if(!s){s=!0;const t=new Date-i,o=e=>t<500?setTimeout(e,500-t):e();"notification"===e.type&&(e=e.text),"info"===e.type||"warning"===e.type?o(()=>this._panel.webview.postMessage({command:"activationSuccess",message:e.text,licenseDetails:d.getLicenseDetails()})):o(()=>this._panel.webview.postMessage({command:"activationError",message:e.text}))}}),e&&setTimeout(()=>{s||(s=!0,this._panel.webview.postMessage({command:"activationError",message:"A timeout occurred while attempting to validate your email address."}))},25e3)}_requestTrialLicense(t){const i=e("https"),s=JSON.stringify({email:t,type:"quokka",referrer:"qsp"}),o={hostname:"x55r2pae4l.execute-api.us-east-1.amazonaws.com",port:443,path:"/Prod/bc88894221b34ae4adac5c39a51547a2",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(s)}},a=i.request(o,e=>{200===e.statusCode?this._panel.webview.postMessage({command:"trialRequestSuccess"}):this._panel.webview.postMessage({command:"trialRequestError"})});a.on("error",e=>{this._panel.webview.postMessage({command:"trialRequestError"}),console.error(e)}),a.write(s),a.end()}static _checkForOffers(t){if(d.controller&&d.controller._salesEvent&&d.controller._salesEvent.saleInProgress())return void t({displayDiscount:!1,sale:!0,saleDiscount:d.controller._salesEvent.discountAmount()});if(void 0!==d._checkOffersResults)return void(d._checkOffersResults.discount&&d._checkOffersResults.discount>5?t(d._checkOffersResults):t({displayDiscount:!1}));let i=!1;e("./checkOffers").checkForOffers(e=>{i||(i=!0,e.offer_price&&e.list_price?(e.discount=Math.floor(100-100*e.offer_price/e.list_price),e.displayDiscount=e.discount>5,e.displayDiscount||(e.discount=0),d.controller&&d.controller._salesEvent&&d.controller._salesEvent.saleInProgress()&&(e.sale=!0,e.saleDiscount=d.controller._salesEvent.discountAmount()),d._checkOffersResults=e,t(e)):t({displayDiscount:!1}))}),setTimeout(()=>{i||(i=!0,d._checkOffersResults={},t({displayDiscount:!1}))},15e3)}static _getUserWhatsNewVersion(){try{return JSON.parse(Buffer.from(r.readFileSync(d.startPage).toString())).version}catch(e){return 0}}static _saveUserWhatsNewVersion(e){try{r.writeFileSync(d.startPage,JSON.stringify({version:e}))}catch(e){console.error(e)}}static getLicenseDetails(){const e=d.controller&&d.controller._buildDate||new Date,t=c.getLicenseDetails(e);var i;return"community"===t.state&&d._checkForOffers(e=>{e&&d.currentPanel&&d.currentPanel._panel&&d.currentPanel._panel.webview.postMessage({command:"countryDiscount",offer:{discount:e.discount,country:(i=e.country,{AF:"Afghanistan",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AG:"Antigua and Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia and Herzegovina",BW:"Botswana",BV:"Bouvet Island",BR:"Brazil",IO:"Brit. Indian Ocean",VG:"British Virgin Islands",BN:"Brunei Darussalam",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CX:"Christmas Island",CC:"Cocos Islands",CO:"Colombia",KM:"Comoros",CG:"Congo",CK:"Cook Islands",CR:"Costa Rica",CI:"Cote D’Ivoire",HR:"Croatia",CU:"Cuba",CW:"Curaçao",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",TF:"French Southern Terr.",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GH:"Ghana",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GU:"Guam",GT:"Guatemala",GG:"Guernsey",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HM:"Heard/ Mcdonald Islands",VA:"Holy See/ Vatican City",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran",IQ:"Iraq",IE:"Ireland",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JE:"Jersey",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KW:"Kuwait",KG:"Kyrgyzstan",LA:"Lao People’s DR",LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libyan Arab Jamahiriya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macao",MK:"Macedonia",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",KP:"North Korea",MP:"Northern Mariana Islands",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PS:"Palestinian Territory",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RS:"Republic of Serbia",RE:"Reunion",RO:"Romania",RU:"Russian Federation",RW:"Rwanda",GS:"S. Georgia/ Sandwich Islands",SH:"Saint Helena",KN:"Saint Kitts and Nevis",LC:"Saint Lucia",PM:"Saint Pierre and Miquelon",VC:"Saint Vincent/ Grenadines",WS:"Samoa",SM:"San Marino",ST:"Sao Tome and Principe",SA:"Saudi Arabia",SN:"Senegal",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",KR:"South Korea",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SJ:"Svalbard and Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syrian Arab Republic",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",TL:"Timor-Leste",TG:"Togo",TK:"Tokelau",TO:"Tonga",TT:"Trinidad and Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks and Caicos Islands",TV:"Tuvalu",VI:"U.S. Virgin Islands",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UM:"United States (M.O.I.)",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VE:"Venezuela",VN:"Vietnam",WF:"Wallis and Futuna",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"}[i]),display:e.displayDiscount,sale:!!e.sale,saleDiscount:e.saleDiscount}})}),t}dispose(){for(d.currentPanel=void 0,this._panel.dispose(),this._panel=void 0;this._disposables.length;){const e=this._disposables.pop();e&&e.dispose()}}_update(){return s(this,void 0,void 0,function*(){const e=this._panel.webview;this._panel.webview.html=yield this._getHtmlForWebview(e)})}_getHtmlForWebview(e){return s(this,void 0,void 0,function*(){const t=o.Uri.joinPath(this._extensionUri,"media","index.html"),i=new a.TextDecoder("utf8").decode(yield o.workspace.fs.readFile(t)),s={nonce:function(){let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let i=0;i<32;i++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}(),cspSource:e.cspSource,root:e.asWebviewUri(this._extensionUri).toString()};return Object.keys(s).reduce((e,t)=>e.replace(new RegExp(("${"+t+"}").replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),"g"),s[t]),i)})}}d.quokkaFolder=n.join(l.homedir(),".quokka"),d.wallabyFolder=n.join(l.homedir(),".wallaby"),d.lkp=n.join(d.quokkaFolder,".qlc"),d.quokkaConfigPath=n.join(d.quokkaFolder,"config.json"),d.olp=n.join(d.wallabyFolder,".ol"),d.startPage=n.join(d.quokkaFolder,"startPage.json"),d.globalDefaults={autoLog:!1,showValueOnSelection:!1,showSingleInlineValue:!0,delay:0,logLimit:100,recycle:!1},d.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],d.viewType="quokkaStartPage",t.exports=d},{"./checkOffers":5,"./licenseReader":8,fs:void 0,https:void 0,os:void 0,path:void 0,util:void 0,vscode:void 0}],12:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function r(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,r)}l((s=s.apply(e,t||[])).next())})};const o=e("vscode"),a=global._,n=o.window,r=e("./compositeDisposable");let l;class c{constructor(e,t){this._ts=+new Date,this._disposables=new r,this._quokkaFileUri=e,this._quokkaFileName=t,this._opacityMultiplier=o.workspace.getConfiguration().get("quokka.dimmedTextOpacity",50),this._onDidChange=new o.EventEmitter,this._onDidChangeCodeLenses=new o.EventEmitter;const i=new o.ThemeColor("editorCodeLens.foreground");this._annotationDecorationType=o.window.createTextEditorDecorationType({rangeBehavior:o.DecorationRangeBehavior.ClosedOpen,textDecoration:"none",before:{height:"100%",margin:"0 26px 0 0"}}),this._subtleDecorationType=o.window.createTextEditorDecorationType({rangeBehavior:o.DecorationRangeBehavior.ClosedOpen,textDecoration:"none",opacity:this._getOpacity(.3)}),this._logDecorationType=o.window.createTextEditorDecorationType({isWholeLine:!0,light:{after:{color:"#0000ff"}},dark:{after:{color:"rgba(86, 156, 214, 1)"}}}),this._systemLogDecorationType=o.window.createTextEditorDecorationType({isWholeLine:!0,after:{color:i}}),this._errorDecorationType=o.window.createTextEditorDecorationType({isWholeLine:!0,light:{after:{color:"#c80000"}},dark:{after:{color:"#fe536a"}}}),this._lineNumberStyle={color:i,opacity:this._getOpacity(.6)},this._fileContentSeparatorStyle={color:i,opacity:this._getOpacity(.5)},this._content={},this._disposables.add(()=>{this._annotationDecorationType.dispose(),this._subtleDecorationType.dispose(),this._logDecorationType.dispose(),this._systemLogDecorationType.dispose(),this._errorDecorationType.dispose()})}_getOpacity(e){if(50===this._opacityMultiplier)return e.toFixed(2);if(this._opacityMultiplier<50)return Math.max(0,e-e*(50-this._opacityMultiplier)/50).toFixed(2);{const t=1-e;return Math.min(1,e+t*(this._opacityMultiplier-50)/50).toFixed(2)}}get onDidChange(){return this._onDidChange.event}get onDidChangeCodeLenses(){return this._onDidChangeCodeLenses.event}_initialize(){this._initialized||(this._definitionProvider=o.languages.registerDefinitionProvider({scheme:"quokka-code-timeline",language:"quokka-timeline"},this),this._codeLensProvider||(this._codeLensProvider=o.languages.registerCodeLensProvider({scheme:"quokka-code-timeline",language:"quokka-timeline"},this)),this._changeRevealIfOpenSetting(),this._initialized=!0)}clear(e){this._initialized&&(this._definitionProvider.dispose(),delete this._content,delete this._expectingTimelineLoad,e.forEach(e=>this._resetAllDecorations(e)),this._uri&&this._onDidChange.fire(this._uri),this._restoreRevealIfOpenSetting(),delete this._uri,delete this._initialized)}uri(){return this._uri}dispose(){this.clear([]),this._codeLensProvider&&(this._codeLensProvider.dispose(),delete this._codeLensProvider)}expectingTimelineLoad(){this._expectingTimelineLoad=!0}isExpectingTimelineLoad(){return this._expectingTimelineLoad}provideTextDocumentContent(){return this._providedTextDocumentContent=l===this._uri?(this._content||{}).text||"":null,this._providedTextDocumentContent}provideDefinition(e,t){if(!this._content||this._updating)return;const i=this._content.lines[t.line];return i&&i.file&&i.num?new o.Location(this._quokkaFileUri,new o.Position(i.num-1,t.character)):void 0}provideCodeLenses(e){if(this._initialized&&(this._onCodeLensProvided&&(this._onCodeLensProvided(),delete this._onCodeLensProvided),this._content&&this._content.codeLens&&!this._updating))return this._content.codeLens}static prepareContentText(e){return e.replace(/ /g," ")}getLineByStep(e){if(this._content)return this._content.lineByStep[e]}getOriginalLocationByLine(e){if(!this._content)return;const t=this._content.lines[e-1];if(!t||!t.file||!t.num)return;let i=t.step;if(!(i>=0))for(let t=e;t<this._content.lines.length&&!((i=this._content.lines[t].step)>=0);t++);return{file:t.file,line:t.num,step:i}}_changeRevealIfOpenSetting(){try{const e=o.workspace.getConfiguration();this._revealIfOpenSetting=(e.inspect("workbench.editor.revealIfOpen")||{}).globalValue,e.update("workbench.editor.revealIfOpen",!0,!0)}catch(e){}}_restoreRevealIfOpenSetting(){try{o.workspace.getConfiguration().update("workbench.editor.revealIfOpen",this._revealIfOpenSetting,!0),delete this._revealIfOpenSetting}catch(e){}}closing(){this._closing=new Promise(e=>{this._closed=e})}isClosing(){return!!this._closing}closed(){this._closed(),delete this._closing,delete this._closed}isActive(){return!this.isClosing()&&this._initialized}show(e,t){return s(this,void 0,void 0,function*(){try{if(!e)return;this._closing&&(t.length=0,yield this._closing);const i=!!t.length;if(this._content=this._generateDecoratedContent(e),this._initialize(),l=this._uri=o.Uri.parse(`quokka-code-timeline://authority/${this._ts}/Quokka Code Story`),!t.length){yield this._updateTimelineDocument();const e={preview:!1,viewColumn:-2,preserveFocus:!0},i=yield o.window.showTextDocument(this._uri,e);i.options.lineNumbers=o.TextEditorLineNumbersStyle.Off,o.languages.setTextDocumentLanguage(i.document,"quokka-timeline"),t=[i]}yield Promise.all(t.map(e=>this._updateEditor(e,i)))}finally{delete this._expectingTimelineLoad}})}_updateTimelineDocument(){return s(this,void 0,void 0,function*(){void 0!==this._providedTextDocumentContent&&this._content.text!==this._providedTextDocumentContent&&(yield new Promise(e=>{const t=o.workspace.onDidChangeTextDocument(s=>{s.document&&s.document.uri&&"quokka-code-timeline"===s.document.uri.scheme&&(clearTimeout(i),t.dispose(),e())}),i=setTimeout(()=>{t.dispose(),e()},2e3);this._onDidChange.fire(this._uri)}))})}_updateEditor(e,t){return s(this,void 0,void 0,function*(){if(this._updating=!0,t){const e=new Promise(e=>{const t=setTimeout(()=>{e()},500);this._onCodeLensProvided=(()=>{clearTimeout(t),setImmediate(e)})});this._onDidChangeCodeLenses.fire(),yield e}yield this._updateTimelineDocument(),delete this._updating,this._onDidChangeCodeLenses.fire(),this._resetAllDecorations(e),this._updateDecorations(e)})}update(e){e.options.lineNumbers=o.TextEditorLineNumbersStyle.Off,this._updateDecorations(e)}isTimelineLoaded(){return!!this._content}_updateDecorations(e){if(!e)return;if(!e.document||!e.document.uri||"quokka-code-timeline"!==e.document.uri.scheme)return;const t=this._content;t?(e.setDecorations(this._annotationDecorationType,t.annotationDecorations),e.setDecorations(this._subtleDecorationType,t.subtleDecorations),e.setDecorations(this._errorDecorationType,t.errorDecorations)):this._resetAllDecorations(e)}_resetAllDecorations(e){e.setDecorations(this._logDecorationType,[]),e.setDecorations(this._systemLogDecorationType,[]),e.setDecorations(this._errorDecorationType,[]),e.setDecorations(this._annotationDecorationType,[]),e.setDecorations(this._subtleDecorationType,[])}updateTimelineEditorInlineValueDecorations(e,t,i){if(!e||!t||!i)return;if(!e.document||!e.document.uri||"quokka-code-timeline"!==e.document.uri.scheme)return;const s=this.getOriginalLocationByLine(t);if(!s)return;const a=i[s.file];if(!a||!a.lines||!a.lines.length)return;const n=a.lines.find(e=>e.num===s.line);if(!n)return;const r=e.document.lineAt(t-1);if(!r)return;const l={range:new o.Range(r.lineNumber,r.firstNonWhitespaceCharacterIndex,r.lineNumber,r.range.end.character)},c=n.log||"",d=n.longLog||c;d&&(l.hoverMessage=o.MarkdownString?new o.MarkdownString("```js\n"+d+"\n```"):d),l.renderOptions={after:{contentText:" ".repeat(2)+c}};const u=n.meta&&n.meta.system?this._systemLogDecorationType:this._logDecorationType;e.setDecorations(this._logDecorationType,[]),e.setDecorations(this._systemLogDecorationType,[]),c&&e.setDecorations(u,[l])}_generateDecoratedContent(e){const t=[],i=[],s=[],a=[];let n,r,l,d;const u=[],h={},p=()=>u.length-1,_=e.maxLineNumber.toString().length,g=e=>{const i=p();t.push({range:new o.Range(i,0,i,1),renderOptions:{before:Object.assign({contentText:c.prepareContentText((e=>`${" ".repeat(_-e.toString().length)}${e}`)(e))},this._lineNumberStyle)}})},m=()=>{const e=p();t.push({range:new o.Range(e,0,e,1),renderOptions:{after:Object.assign({contentText:c.prepareContentText("…")},this._fileContentSeparatorStyle)}})},v=(e,t,a)=>{for(const l of t){const t=l.n||"",c=l.content?`${l.content}`:l.separator?"​​":" ",d={text:c,num:t,file:e};u.push(d),l.separator&&m();const _=p();if(l.executedLine){l.steps=l.steps||[a];for(const e of l.steps)h[e]=_;if(l.error){const e={range:new o.Range(_,0,_,c.length)},t=l.error;e.renderOptions={after:{contentText:" ".repeat(2)+t}},s.push(e)}d.step=l.steps[0],void 0===n&&(n=d.step),r=l.steps[l.steps.length-1]}if((!l.executedLine||l.contextRanges)&&!l.separator)if(l.contextRanges)for(const[e,t]of l.contextRanges)i.push({range:new o.Range(_,e,_,t)});else i.push({range:new o.Range(_,0,_,c.length)});g(t)}};e.truncatedStart&&(u.unshift({text:"​"}),l=new o.CodeLens(new o.Range(1,0,1,1),{title:"Load previous entries",command:"quokka.viewCodeStory"}),u.push({text:"​"}));for(const t of e.entries)t.file&&(t.file,u.push({text:"​"}),t.hideable&&a.push(new o.CodeLens(new o.Range(u.length-2,0,u.length-2,1),{title:"Hide repeated entries like this",command:"quokka.viewCodeStory",arguments:[{hide:t}]}))),v(t.file,t.lines,t.step),u.push({text:"​"});return e.truncatedEnd&&(u.push({text:" "}),u.push({text:" "}),d=new o.CodeLens(new o.Range(u.length-1,0,u.length-1,1),{title:"Load next entries",command:"quokka.viewCodeStory"})),l&&(l.command.arguments=[{before:n}],a.push(l)),d&&(d.command.arguments=[{after:r}],a.push(d)),{lines:u,lineByStep:h,text:u.map(e=>e.text).join("\n"),annotationDecorations:t,subtleDecorations:i,errorDecorations:s,codeLens:a}}}class d{constructor(e,t,i){this._traceContext={},this._onUpdate=[],this._extensionContext=e,this._session=i,this.id=i.id}asAbsolutePath(e){return this._extensionContext.asAbsolutePath(e)}scheduleOnUpdate(e){this._onUpdate.push(e)}runPendingUpdates(){a.each(this._onUpdate,e=>{try{return e()}catch(e){}}),this._onUpdate.length=0}requestTrace(e){return new Promise(t=>this._session.requestTrace(e,e=>t(e)))}updateTraceContextCurrentFrame(e,t=!0){this._session.isDisposed()||this._session.traceContext({currentFrame:e,captureCallStackFrame:t?this._traceContext.frame:void 0})}requestCallStack(){this._session.isDisposed()||(this._session.traceContext({captureCallStackFrame:this._traceContext.frame}),this._session.runTests({file:this._session.fileName,evaluateExpression:!0}))}stopTraceNavigation(){this._session.isDisposed()||(this._session.output.refreshHeaderCommands(),this._session.traceContext({stopNavigation:!0}))}traceNavigationStarted(){this._session.output.refreshHeaderCommands()}requestTestTimeline(e,t){return this._session.requestTestTimeline(e,t)}}t.exports=class{constructor(e,t,i){this._disposables=new r,this._activeTraceFrameWithNowhereToGoDecorationType=n.createTextEditorDecorationType({rangeBehavior:1,borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",dark:{backgroundColor:"rgba(255, 0, 0, 0.2)",borderColor:"rgba(255, 0, 0, 0.2)"},light:{backgroundColor:"rgba(255, 0, 52, 0.35)",borderColor:"rgba(255, 0, 52, 0.35)"}}),this._activeTraceFrameDecorationType=n.createTextEditorDecorationType({rangeBehavior:1,borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",dark:{backgroundColor:"rgba(255, 255, 0, 0.2)",borderColor:"rgba(255, 255, 0, 0.2)"},light:{backgroundColor:"rgba(255, 255, 102, 0.45)",borderColor:"rgba(255, 255, 102, 0.45)"}}),this._activeTraceCallStackFrameDecorationType=n.createTextEditorDecorationType({rangeBehavior:1,borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",dark:{backgroundColor:"rgba(122, 189, 122, 0.3)",borderColor:"rgba(122, 189, 122, 0.3)"},light:{backgroundColor:"rgba(206, 231, 206, 0.45)",borderColor:"rgba(206, 231, 206, 0.45)"}}),this._codeStoryContentProvider=new c(i.textDocument.uri,i.fileName),this._disposables.add(o.workspace.registerTextDocumentContentProvider("quokka-code-timeline",this._codeStoryContentProvider)),this._disposables.add(()=>{this._activeTraceFrameWithNowhereToGoDecorationType.dispose(),this._activeTraceFrameDecorationType.dispose(),this._activeTraceCallStackFrameDecorationType.dispose(),this._codeStoryContentProvider.dispose(),this._setTraceBeingNavigatedContext(!1)}),this._sessionContext=new d(e,t,i),this._onTraceNavigationStarted=new o.EventEmitter,this.onTraceNavigationStarted=this._onTraceNavigationStarted.event}requestTrace(e={}){return this._sessionContext.requestTrace(e)}traceNavigated(e){const t={};return e&&(this._currentStep=e,this._sessionContext._traceContext.frame=e.frame),!this.traceBeingNavigated()&&this._autoPlayCodeOnStart&&(this.autoPlayCode(),delete this._autoPlayCodeOnStart),this._setTraceBeingNavigatedContext(!0),this._sessionContext.traceNavigationStarted(),!e&&this.lastActiveStep()&&(t.decorationType=this._activeTraceFrameWithNowhereToGoDecorationType,t.step=this.lastActiveStep(),this.traceBeingAutoPlayed()&&o.commands.executeCommand("quokka.pauseCodeExecution")),e&&(t.decorationType=this._activeTraceFrameDecorationType,t.step=e),t}activeTraceFrameDecorationType(){return this._activeTraceFrameDecorationType}activeTraceCallStackFrameDecorationType(){return this._activeTraceCallStackFrameDecorationType}lastActiveStep(){return this._currentStep}dispose(){this._disposed||(this.closeCodeStory(!0),this._disposables.dispose(),this._disposed=!0,delete this._currentStep,clearTimeout(this._autoPlayTimeout),delete this._autoPlayTimeout)}destroyStackTraceDecorations(e){if(e)try{e.setDecorations(this._activeTraceFrameDecorationType,[]),e.setDecorations(this._activeTraceCallStackFrameDecorationType,[]),e.setDecorations(this._activeTraceFrameWithNowhereToGoDecorationType,[])}catch(e){}}anyVisibleCodeStoryEditors(){return!!n.visibleTextEditors.find(e=>this.isCodeStoryViewer(e))}isCodeStoryViewer(e){return e&&e.document&&e.document.uri&&"quokka-code-timeline"===e.document.uri.scheme}isActiveCodeStoryViewer(e){return this.isCodeStoryViewer(e)&&this._codeStoryContentProvider.isActive()}getCodeStoryLineByStep(e){return this._codeStoryContentProvider.getLineByStep(e)}getOriginalLocationByCodeStoryLine(e){return this._codeStoryContentProvider.getOriginalLocationByLine(e)}forEachVisibleCodeStoryEditor(e){return n.visibleTextEditors.filter(e=>this.isCodeStoryViewer(e)).forEach(e)}_visibleCodeStoryEditors(){return n.visibleTextEditors.filter(e=>this.isCodeStoryViewer(e))}viewCodeStory(e={reveal:!0}){return s(this,void 0,void 0,function*(){if(!this._codeStoryContentProvider.isExpectingTimelineLoad())return this._codeStoryContentProvider.expectingTimelineLoad(),new Promise(t=>this._sessionContext.requestTestTimeline(e,e=>s(this,void 0,void 0,function*(){yield this._codeStoryContentProvider.show(e,this._visibleCodeStoryEditors()),t()})))})}closeCodeStory(e){return s(this,void 0,void 0,function*(){const t=this._codeStoryContentProvider.uri();if(this._codeStoryContentProvider.clear(this._visibleCodeStoryEditors()),t&&!this._codeStoryContentProvider.isClosing())try{this._codeStoryContentProvider.closing(),e&&(yield n.showTextDocument(t,{preserveFocus:!1}),yield new Promise(e=>setTimeout(()=>e(),100)),this.isCodeStoryViewer(n.activeTextEditor)&&(yield o.commands.executeCommand("workbench.action.closeActiveEditor")))}catch(e){}finally{this._codeStoryContentProvider.closed()}})}updateTimelineEditorInlineValueDecorations(e,t,i){return this._codeStoryContentProvider.updateTimelineEditorInlineValueDecorations(e,t,i)}isClosingCodeStory(){return this._codeStoryContentProvider.isClosing()}updateCodeStoryIfLoaded(e){if(this._codeStoryContentProvider.isTimelineLoaded())return this._codeStoryContentProvider.update(e),!0}traceBeingNavigated(){return this._traceBeingNavigated}traceBeingAutoPlayed(){return!!this._autoPlayTimeout}stopTraceNavigation(){a.each(n.visibleTextEditors,e=>this.destroyStackTraceDecorations(e)),this._setTraceBeingNavigatedContext(!1),this.pauseCodeExecution(),this._sessionContext.stopTraceNavigation()}requestCallStack(){this._sessionContext.requestCallStack()}updateTraceContextCallStackFrame(e){this._sessionContext.updateTraceContextCurrentFrame(e.frame)}hideCallStack(){this._sessionContext.updateTraceContextCurrentFrame(this._currentStep&&this._currentStep.frame,!1)}autoPlayCodeOnStart(){this._autoPlayCodeOnStart=!0}autoPlayCode(){o.commands.executeCommand("setContext","quokka.traceBeingAutoPlayed",!0),this._autoPlayCode()}_autoPlayCode(e=!0){const t=o.workspace.getConfiguration().get("quokka.codeAutoPlayDelay",1e3),i=Math.max(t-50,50);this._autoPlayTimeout=setTimeout(()=>{e?a.each(n.visibleTextEditors,e=>this.destroyStackTraceDecorations(e)):o.commands.executeCommand("quokka.playTraceNextStep"),this._autoPlayCode(!e)},e?i:50)}pauseCodeExecution(){o.commands.executeCommand("setContext","quokka.traceBeingAutoPlayed",!1),clearTimeout(this._autoPlayTimeout),delete this._autoPlayTimeout}_setTraceBeingNavigatedContext(e){o.commands.executeCommand("setContext","quokka.traceBeingNavigated",e);const t=!!this._traceBeingNavigated;this._traceBeingNavigated=e,e&&!t&&this._onTraceNavigationStarted.fire()}}},{"./compositeDisposable":6,vscode:void 0}],13:[function(e,t,i){"use strict";const s=e("vscode"),o=global._;class a{constructor(e){this._context=e,this._docsNode=this._createDocsNode(),this._treeDataProvider=new l(this._docsNode),this._treeDataProvider._rootNodes={},this._treeView=s.window.createTreeView("quokkaValueExplorer",{treeDataProvider:this._treeDataProvider}),this._treeView.onDidExpandElement(e=>e.element.uiCollapsibleState=2),this._treeView.onDidCollapseElement(e=>e.element.uiCollapsibleState=1)}_createDocsNode(e){return{label:"No logged values, click to see the feature docs",iconPath:this._context.asAbsolutePath("images/question.svg"),command:{command:"vscode.open",arguments:[s.Uri.parse("https://quokkajs.com/docs/#value-explorer")]},getParent:()=>e,getLine:()=>void 0}}remove(e){const t=this._treeDataProvider._rootNodes,i=t[e.id];delete t[e.id],i&&i._context.cancelPendingUpdates(),this._treeDataProvider.refresh()}update(e,t){let i=this._treeDataProvider._rootNodes[e.id];if(!i){const t=new n(this._context,e);i=new r(t,{label:{name:`${e.id}`},id:e.id,sessionNode:!0,disallowToCopyPath:!0,disallowToCopyData:!0}),this._treeDataProvider._rootNodes[e.id]=i}i._children=o.chain(t).map(e=>{let t=(e.valueBag||{}).data;if(!t)return;t.name||a.removeExcessiveSpacesTabsLineBreaks(e.text||"").startsWith(a.removeExcessiveSpacesTabsLineBreaks(e.context||"").replace(/\.\.\.$/g,""))||(t.name=a.removeExcessiveSpacesTabsLineBreaks(e.context||""));const i=(e.loc||"").split(":")[0];return i&&(t.name=`line ${i}${t.name?`: ${t.name}`:""}`,t.line=parseInt(i,10)),t.label=t.label||{},t.label.name=t.name,t.context=e.context,t.rootValueNode=!0,t}).filter(e=>!!e).map(e=>new r(i._context,e,i,e.autoExpand)).value(),i._context.runPendingUpdates(),i._children&&i._children.length||(i._children=[this._createDocsNode(i)]),this._treeDataProvider.refresh()}reveal(e,t){const i=this._treeDataProvider._rootNodes[e];if(!i)return this._reveal(this._docsNode,{expand:!1,focus:!1,select:!1});const s={expand:!0,focus:!0},o=i.getChildren();if(o)if("function"==typeof o[Symbol.iterator]){for(const e of o)if(e.getLine()===t)return void this._reveal(e,s);this._reveal(i,s)}else o.then(()=>{const i=this._treeDataProvider._rootNodes[e];if(i){const e=i.getChildren();if(e)for(const i of e)if(i.getLine()===t)return void this._reveal(i,s);this._reveal(i,s)}});else this._reveal(i,s)}_reveal(e,t){return this._treeView.reveal(e,t).catch(()=>this._treeView.reveal(e,t).catch(e=>console.error(e)))}static removeExcessiveSpacesTabsLineBreaks(e){return e&&e.replace(/\r\n\s*/g," ").replace(/\n\s*/g," ")}}class n{constructor(e,t){this._expressionsToEvaluate={},this._onUpdate=[],this._extensionContext=e,this._session=t,this.id=t.id}asAbsolutePath(e){return this._extensionContext.asAbsolutePath(e)}getPathData(e){let t=this._expressionsToEvaluate;return o.each(e,e=>{t[e]=t[e]||{},t=t[e]}),t}isPathRequested(e,t){let i=this._expressionsToEvaluate;const s=o.every(e,e=>!!i[e]&&(i=i[e],!0));return s&&t?JSON.stringify(t)===JSON.stringify(i):s}requestNodes(e,t){let i=this._expressionsToEvaluate;o.each(e,e=>{i[e]=i[e]||{},i=i[e]}),t&&(i.props=t.props,i.strLength=t.strLength,i.ranges=t.ranges),this._session.isDisposed()||(this._session.expressionsToEvaluate(this._expressionsToEvaluate),this._session.runTests({file:this._session.fileName}))}scheduleOnUpdate(e){this._onUpdate.push(e)}copyToClipboard(e){!this._session.isDisposed()&&this._session.copyToClipboard(e)}cancelPendingUpdates(){this._onUpdate=[]}runPendingUpdates(){o.each(this._onUpdate,e=>e()),this._onUpdate.length=0}}class r{constructor(e,t,i,o){this._context=e,this._parent=i,this._data=t;const{label:a,description:n}=this._createLabelAndDescription();this.label=a,this.description=n,this._queryPath=t.queryPath,this.id=(o?"A":"")+this._context.id+"."+t.id,this.iconPath=this._getIconPath(),t.disallowToCopyPath||(this.contextValue+="QuokkaAllowToCopyPath"),t.disallowToCopyData||(this.contextValue+="QuokkaAllowToCopyData"),this._autoExpand=o&&!this._data.cappedProps&&!this._data.capped&&!this._data.loadActionNode&&!this._data.rangeNode&&"string"!==this._data.type&&!this._data.getter&&!this._data.setter,t.sessionNode?this.collapsibleState=2:this.collapsibleState=t.expandable?this._autoExpand?2:1:0,t.rangeNode&&(this._parentArray=i._parentArray||i,this._queryPath=this._parentArray._queryPath),t.sessionNode&&(this.iconPath=s.ThemeIcon.File,this.resourceUri=s.Uri.file(this.id))}getChildren(){if(this._children)return this._children;if("string"===this._data.type)return this._getChildren({strLength:Number.MAX_VALUE});if(this._data.loadActionNode)return this._getChildren({props:Number.MAX_VALUE});const e=(this._data.props&&this._data.props.length?this._data.props:[]).map(e=>new r(this._context,e,this,this._autoExpand)),t=e=>e._data.functionsNode||e._data.loadActionNode||e._data.callStackNode;if(this._data.rangeNode||"array"===this._data.type||"Map"===this._data.type||"Set"===this._data.type||e.sort(function(e,i){if(t(e)||t(i))return 0;const s=((e._data.label||{}).name||"").toLowerCase(),o=((i._data.label||{}).name||"").toLowerCase();return s<o?-1:s>o?1:0}),e.length)return Promise.resolve(e);if(this._data.rangeNode){let e=this._context.getPathData(this._queryPath);const t=new Set((e.ranges&&e.ranges.props||[]).filter(e=>!0===e.props||e.props.length&&!e.props[0].rangeNode).map(e=>e.id));return this._getChildren({ranges:{props:JSON.parse(JSON.stringify(this._parentArray._data.props,(e,i)=>(i.props&&(!i.props.length&&i===this._data||i.props.length&&!i.props[0].rangeNode||t.has(i.id))&&(i.props=!0),i))),length:this._parentArray._data.length}})}return this._getChildren()}getParent(){return this._parent}getLine(){return this._data.line}copyExpressionPath(){(this._data||{}).expressionPath&&this._context.copyToClipboard(this._data.expressionPath.join(""))}copyExpressionData(){this._data&&this._context.copyToClipboard(this._data)}_getChildren(e){return this._context.isPathRequested(this._queryPath,e)?[]:(this._context.requestNodes(this._queryPath,e),new Promise((e,t)=>{this._context.scheduleOnUpdate(e)}))}_getIconPath(){if(this._data.getter)return this._context.asAbsolutePath("images/getter.svg");if(this._data.functionsNode)return this._context.asAbsolutePath("images/function.svg");if(this._data.loadActionNode)return this._context.asAbsolutePath("images/more.svg");if(this._data.error)return this._context.asAbsolutePath("images/error.svg");if(this._data.rangeNode)return this._context.asAbsolutePath("images/range.svg");if(!this._data.sessionNode){if(this._data.type)switch(this._data.type.toLowerCase()){case"string":if(this._data.capped)return this._context.asAbsolutePath("images/cappedString.svg");case"object":case"array":case"number":case"function":case"boolean":case"date":case"regexp":case"symbol":case"null":case"undefined":return this._context.asAbsolutePath(`images/${this._data.type.toLowerCase()}.svg`)}return this._context.asAbsolutePath("images/object.svg")}}_createLabelAndDescription(){const e=this._parent&&this._parent._data&&this._parent._data.sessionNode,t={label:"",description:""},i=this._data.label;return e?(t.label=i.value||"",t.description=(i.name||"")+(i.type?` ${i.type}`:"")):(i.name&&(t.label+=i.name),i.value&&(t.label+=(i.name?": ":"")+i.value),i.type&&(t.description=`${i.type}`)),t}}class l{constructor(e){this._onDidChangeTreeData=new s.EventEmitter,this.onDidChangeTreeData=this._onDidChangeTreeData.event,this._docsNode=e}refresh(){this._onDidChangeTreeData.fire()}getTreeItem(e){return e}getParent(e){if(e)return e.getParent()}getChildren(e){return e?e.getChildren():o.isEmpty(this._rootNodes)?Promise.resolve([this._docsNode]):Promise.resolve(o.chain(this._rootNodes).values().sortBy(e=>e._data.name).value())}}t.exports=a},{vscode:void 0}]},{},[2]);